var re=Object.defineProperty;var K=e=>{throw TypeError(e)};var se=(e,t,n)=>t in e?re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var m=(e,t,n)=>se(e,typeof t!="symbol"?t+"":t,n),j=(e,t,n)=>t.has(e)||K("Cannot "+n);var a=(e,t,n)=>(j(e,t,"read from private field"),n?n.call(e):t.get(e)),L=(e,t,n)=>t.has(e)?K("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),k=(e,t,n,o)=>(j(e,t,"write to private field"),o?o.call(e,n):t.set(e,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();var i;(function(e){e.LOAD="LOAD",e.EXEC="EXEC",e.FFPROBE="FFPROBE",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.RENAME="RENAME",e.CREATE_DIR="CREATE_DIR",e.LIST_DIR="LIST_DIR",e.DELETE_DIR="DELETE_DIR",e.ERROR="ERROR",e.DOWNLOAD="DOWNLOAD",e.PROGRESS="PROGRESS",e.LOG="LOG",e.MOUNT="MOUNT",e.UNMOUNT="UNMOUNT"})(i||(i={}));const ae=(()=>{let e=0;return()=>e++})(),ie=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),ce=new Error("called FFmpeg.terminate()");var w,T,N,A,b,C,h;class le{constructor(){L(this,w,null);L(this,T,{});L(this,N,{});L(this,A,[]);L(this,b,[]);m(this,"loaded",!1);L(this,C,()=>{a(this,w)&&(a(this,w).onmessage=({data:{id:t,type:n,data:o}})=>{switch(n){case i.LOAD:this.loaded=!0,a(this,T)[t](o);break;case i.MOUNT:case i.UNMOUNT:case i.EXEC:case i.FFPROBE:case i.WRITE_FILE:case i.READ_FILE:case i.DELETE_FILE:case i.RENAME:case i.CREATE_DIR:case i.LIST_DIR:case i.DELETE_DIR:a(this,T)[t](o);break;case i.LOG:a(this,A).forEach(r=>r(o));break;case i.PROGRESS:a(this,b).forEach(r=>r(o));break;case i.ERROR:a(this,N)[t](o);break}delete a(this,T)[t],delete a(this,N)[t]})});L(this,h,({type:t,data:n},o=[],r)=>a(this,w)?new Promise((s,c)=>{const f=ae();a(this,w)&&a(this,w).postMessage({id:f,type:t,data:n},o),a(this,T)[f]=s,a(this,N)[f]=c,r==null||r.addEventListener("abort",()=>{c(new DOMException(`Message # ${f} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(ie));m(this,"load",({classWorkerURL:t,...n}={},{signal:o}={})=>(a(this,w)||(k(this,w,t?new Worker(new URL(t,import.meta.url),{type:"module"}):new Worker(new URL("/stream/assets/worker-DYSz7Krg.js",import.meta.url),{type:"module"})),a(this,C).call(this)),a(this,h).call(this,{type:i.LOAD,data:n},void 0,o)));m(this,"exec",(t,n=-1,{signal:o}={})=>a(this,h).call(this,{type:i.EXEC,data:{args:t,timeout:n}},void 0,o));m(this,"ffprobe",(t,n=-1,{signal:o}={})=>a(this,h).call(this,{type:i.FFPROBE,data:{args:t,timeout:n}},void 0,o));m(this,"terminate",()=>{const t=Object.keys(a(this,N));for(const n of t)a(this,N)[n](ce),delete a(this,N)[n],delete a(this,T)[n];a(this,w)&&(a(this,w).terminate(),k(this,w,null),this.loaded=!1)});m(this,"writeFile",(t,n,{signal:o}={})=>{const r=[];return n instanceof Uint8Array&&r.push(n.buffer),a(this,h).call(this,{type:i.WRITE_FILE,data:{path:t,data:n}},r,o)});m(this,"mount",(t,n,o)=>{const r=[];return a(this,h).call(this,{type:i.MOUNT,data:{fsType:t,options:n,mountPoint:o}},r)});m(this,"unmount",t=>{const n=[];return a(this,h).call(this,{type:i.UNMOUNT,data:{mountPoint:t}},n)});m(this,"readFile",(t,n="binary",{signal:o}={})=>a(this,h).call(this,{type:i.READ_FILE,data:{path:t,encoding:n}},void 0,o));m(this,"deleteFile",(t,{signal:n}={})=>a(this,h).call(this,{type:i.DELETE_FILE,data:{path:t}},void 0,n));m(this,"rename",(t,n,{signal:o}={})=>a(this,h).call(this,{type:i.RENAME,data:{oldPath:t,newPath:n}},void 0,o));m(this,"createDir",(t,{signal:n}={})=>a(this,h).call(this,{type:i.CREATE_DIR,data:{path:t}},void 0,n));m(this,"listDir",(t,{signal:n}={})=>a(this,h).call(this,{type:i.LIST_DIR,data:{path:t}},void 0,n));m(this,"deleteDir",(t,{signal:n}={})=>a(this,h).call(this,{type:i.DELETE_DIR,data:{path:t}},void 0,n))}on(t,n){t==="log"?a(this,A).push(n):t==="progress"&&a(this,b).push(n)}off(t,n){t==="log"?k(this,A,a(this,A).filter(o=>o!==n)):t==="progress"&&k(this,b,a(this,b).filter(o=>o!==n))}}w=new WeakMap,T=new WeakMap,N=new WeakMap,A=new WeakMap,b=new WeakMap,C=new WeakMap,h=new WeakMap;var H;(function(e){e.MEMFS="MEMFS",e.NODEFS="NODEFS",e.NODERAWFS="NODERAWFS",e.IDBFS="IDBFS",e.WORKERFS="WORKERFS",e.PROXYFS="PROXYFS"})(H||(H={}));const de=new Error("failed to get response body reader"),fe=new Error("failed to complete download"),ue="Content-Length",pe=e=>new Promise((t,n)=>{const o=new FileReader;o.onload=()=>{const{result:r}=o;r instanceof ArrayBuffer?t(new Uint8Array(r)):t(new Uint8Array)},o.onerror=r=>{var s,c;n(Error(`File could not be read! Code=${((c=(s=r==null?void 0:r.target)==null?void 0:s.error)==null?void 0:c.code)||-1}`))},o.readAsArrayBuffer(e)}),Ee=async e=>{let t;if(typeof e=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(e)?t=atob(e.split(",")[1]).split("").map(n=>n.charCodeAt(0)):t=await(await fetch(e)).arrayBuffer();else if(e instanceof URL)t=await(await fetch(e)).arrayBuffer();else if(e instanceof File||e instanceof Blob)t=await pe(e);else return new Uint8Array;return new Uint8Array(t)},me=async(e,t)=>{var r;const n=await fetch(e);let o;try{const s=parseInt(n.headers.get(ue)||"-1"),c=(r=n.body)==null?void 0:r.getReader();if(!c)throw de;const f=[];let u=0;for(;;){const{done:R,value:O}=await c.read(),I=O?O.length:0;if(R){if(s!=-1&&s!==u)throw fe;t&&t({url:e,total:s,received:u,delta:I,done:R});break}f.push(O),u+=I,t&&t({url:e,total:s,received:u,delta:I,done:R})}const p=new Uint8Array(u);let E=0;for(const R of f)p.set(R,E),E+=R.length;o=p.buffer}catch(s){console.log("failed to send download progress event: ",s),o=await n.arrayBuffer()}return o},z=async(e,t,n=!1,o)=>{const r=n?await me(e,o):await(await fetch(e)).arrayBuffer(),s=new Blob([r],{type:t});return URL.createObjectURL(s)},Q=document.getElementById("transcodeStatus"),x=document.getElementById("transcodeText"),ee=document.getElementById("transcodeBar"),d={NONE:"none",TRANSCODING:"doing",DONE:"done",ERROR:"error",SKIPPED:"skipped"};console.log("[DEBUG]",{crossOriginIsolated:window.crossOriginIsolated,sab:typeof SharedArrayBuffer,location:location.href});let B=null,D=null,P=!1;function he(){if(D&&D.readyState===WebSocket.OPEN)return;const t=`${location.protocol==="https:"?"wss":"ws"}://${location.host}/ws/stream`;D=new WebSocket(t);let n=null;D.onopen=()=>{n=setInterval(()=>{D.readyState===WebSocket.OPEN&&D.send(JSON.stringify({type:"keepalive"}))},25e3),console.log("[WS] stream connected")},D.onclose=()=>{clearInterval(n),console.warn("[WS] stream disconnected")},D.onerror=o=>{clearInterval(n),console.warn("[WS] stream error",o)},D.onmessage=o=>{let r;try{r=JSON.parse(o.data)}catch{console.warn("[WARN] failed to parse websocket message");return}console.log("receive websocket message"),r.type==="stream-status"&&(r.status==="error"&&l("‚ùå Êé®ÊµÅÂá∫ÈîôÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò","error"),r.status==="stopped"&&l("‚èπ Êé®ÊµÅÂ∑≤ÁªìÊùü","info"),r.status==="running"&&l("‚úÖ Êé®ÊµÅ‰∏≠","ok"),r.status==="info"&&l(`${r.message}`,"info"))}}async function G(){if(B)return B;const e=await fetch("/api/internal/admin-token");if(!e.ok)throw new Error("Êó†Ê≥ïËé∑Âèñ admin token");return B=(await e.json()).token,B}const g=[],M=new Set,X=document.getElementById("playlist"),Y=document.getElementById("emptyTip"),J=document.getElementById("status"),F=document.getElementById("mode"),$=document.getElementById("loopSelector"),W=document.getElementById("loopTarget"),ge=document.getElementById("fileInput");function te(e){return`${e.name}|${e.size}|${e.lastModified}`}function we(e){return(e/1024/1024).toFixed(1)+" MB"}function l(e,t=""){J.textContent=e,J.className="status "+t}function y(){if(X.innerHTML="",W.innerHTML="",g.length===0){Y.style.display="block",$.classList.add("hidden");return}Y.style.display="none",g.forEach((e,t)=>{const n=e.originalFile;let o="",r="";e.transcodeStatus===d.DONE||e.transcodeStatus===d.SKIPPED?(o="‚úÖ Â∑≤ËΩ¨Á†Å",r="ok"):e.transcodeStatus===d.TRANSCODING?(o="‚è≥ Ê≠£Âú®ËΩ¨Á†Å",r="info"):e.transcodeStatus===d.ERROR&&(o="‚ùå ËΩ¨Á†ÅÂ§±Ë¥•",r="error");let s=`
            <div class="actions">
                <button onclick="removeItem(${t})">ÁßªÈô§</button>
            </div>
        `;e.transcodeStatus===d.ERROR&&(s=`
                <div class="actions">
                <button onclick="retryTranscode(${t})">üîÅ ÈáçËØï</button>
                <button onclick="removeItem(${t})">ÁßªÈô§</button>
                </div>
            `);const c=document.createElement("li");c.innerHTML=`
            <span>
                ${t+1}. ${n.name}
                <span class="small">(${we(n.size)})</span>
                ${o?`<span class="small ${r}" style="margin-left:8px;">${o}</span>`:""}
            </span>
            ${s}
            `,X.appendChild(c);const f=document.createElement("option");f.value=t,f.textContent=n.name,W.appendChild(f)}),F.value==="loop"&&$.classList.remove("hidden")}async function Re(e){const t=g[e];t&&(t.transcodeStatus=d.NONE,y(),l(`ËØ∑ÁÇπÂáªÂºÄÂßãÊé®ÊµÅÊù•ÈáçÊñ∞ËΩ¨Á†ÅÔºö${t.originalFile.name}`))}function Oe(){return g.some(e=>e.transcodeStatus===d.ERROR)}function ye(){return g.some(e=>e.transcodeStatus===d.DONE||e.transcodeStatus===d.SKIPPED)}function Se(e){const n=g[e].originalFile;M.delete(te(n)),g.splice(e,1),y()}async function Ie(e){const t=await e.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",t);return[...new Uint8Array(n)].map(o=>o.toString(16).padStart(2,"0")).join("")}async function q(e){const t=await G(),n=await fetch("/api/stream/check",{method:"POST",headers:{"Content-Type":"application/json","x-admin-token":t},body:JSON.stringify({fingerprint:e})});return n.ok?await n.json():null}function U(){Q.style.display="none"}function ne(){const e=navigator.userAgent;if(/^((?!chrome|android).)*safari/i.test(e))return!1;let n=!1;try{n=typeof SharedArrayBuffer<"u"}catch{n=!1}return!De()&&n&&"Worker"in window}function De(){return/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)}async function Ne(){if(g.length===0){l("‚ùå Êí≠ÊîæÂàóË°®‰∏∫Á©∫","error");return}const e=F.value,t=new FormData;l("‚è≥ ÂáÜÂ§áÊé®ÊµÅ‚Ä¶");const n=await G(),o=ne();l(o?"üñ•Ô∏è Ê°åÈù¢ÁéØÂ¢ÉÔºå‰ΩøÁî®ÂÆ¢Êà∑Á´ØËΩ¨Á†Å‚Ä¶":"üì± ÁßªÂä®Á´ØÊàñ‰∏çÊîØÊåÅËΩ¨Á†ÅÔºå‰ΩøÁî®ÊúçÂä°Âô®ËΩ¨Á†Å‚Ä¶");const r=[],s=[];if(e==="loop"){const u=Number(W.value),p=g[u],E=p.originalFile,R=p.fingerprint,O=await q(R);if(O!=null&&O.exists)s.push({filePath:O.path,index:u}),p.transcodeStatus=d.DONE,y();else{if(!o){l("‚ùå ÂΩìÂâçÁéØÂ¢É‰∏çÊîØÊåÅÂÆ¢Êà∑Á´ØËΩ¨Á†Å","error");return}console.log("[INFO] ÂºÄÂßãËΩ¨Á†Å..."),v(0,"ÂáÜÂ§áËΩ¨Á†ÅÁ¨¨ 1 / 1 ‰∏™ËßÜÈ¢ë"),p.transcodeStatus=d.TRANSCODING,y();const I=await Z(E,0,1);r.push({file:I,fingerprint:R,index:u}),p.transcodeStatus=d.DONE,y()}t.append("loopIndex",u)}else{const u=g.length;for(let p=0;p<g.length;p++){const E=g[p];if(E.transcodeStatus===d.DONE||E.transcodeStatus===d.SKIPPED){E.transcodeStatus=d.SKIPPED;continue}if(E.transcodeStatus===d.ERROR)continue;const R=E.originalFile,O=E.fingerprint,I=await q(O);if(I!=null&&I.exists){s.push({filePath:I.path,index:p}),E.transcodeStatus=d.DONE,y();continue}if(!o){l("‚ùå ÂΩìÂâçÁéØÂ¢É‰∏çÊîØÊåÅÂÆ¢Êà∑Á´ØËΩ¨Á†Å","error");return}v(0,`ÂáÜÂ§áËΩ¨Á†ÅÁ¨¨ ${p+1} / ${u} ‰∏™ËßÜÈ¢ëÔºö${R.name}`),E.transcodeStatus=d.TRANSCODING,y(),console.log("[INFO] ÂºÄÂßãËΩ¨Á†Å...");try{const _=await Z(R,p,u);r.push({file:_,fingerprint:O,index:p}),E.transcodeStatus=d.DONE,y()}catch(_){if(String(_==null?void 0:_.message).includes("called FFmpeg.terminate()")){E.transcodeStatus=d.NONE,l("ËΩ¨Á†ÅÂèñÊ∂à"),y(),U();return}else E.transcodeStatus=d.ERROR;p==u-1&&U(),y();continue}}}if(s.length==0&&r.length==0){l("Êñá‰ª∂ËΩ¨Á†ÅÂ§±Ë¥•","error");return}for(const u of s)t.append("existing",JSON.stringify(u));for(const u of r)t.append("files",u.file,u.file.name),t.append("fingerprints",u.fingerprint);if(r.length>0&&t.append("clientTranscoded","1"),t.append("mode",e),U(),Oe()){if(!ye()){alert("‚ùå ÊâÄÊúâËßÜÈ¢ëÂùáËΩ¨Á†ÅÂ§±Ë¥•ÔºåÊó†Ê≥ïÂºÄÂßãÊé®ÊµÅ"),l("‚ùå ËΩ¨Á†ÅÂ§±Ë¥•ÔºåËØ∑Â§ÑÁêÜÂêéÈáçËØï","error");return}if(l("‚ö†Ô∏è ËΩ¨Á†ÅÂÆåÊàêÔºåÂ≠òÂú®Â§±Ë¥•ËßÜÈ¢ëÔºåÁ≠âÂæÖÁ°ÆËÆ§‚Ä¶"),!window.confirm(`‚ö†Ô∏è ÊúâËßÜÈ¢ëËΩ¨Á†ÅÂ§±Ë¥•„ÄÇ

ÁÇπÂáª„ÄåÁ°ÆÂÆö„ÄçÂ∞ÜÂøΩÁï•Â§±Ë¥•ÁöÑËßÜÈ¢ëÔºå‰ªÖÊé®ÊµÅÂ∑≤ËΩ¨Á†ÅÊàêÂäüÁöÑÂÜÖÂÆπ„ÄÇ
ÁÇπÂáª„ÄåÂèñÊ∂à„ÄçËøîÂõûÂ§ÑÁêÜÂ§±Ë¥•ËßÜÈ¢ëÔºàÈáçËØïÊàñÁßªÈô§Ôºâ„ÄÇ`)){l("‚è∏ Â∑≤ÂèñÊ∂àÊé®ÊµÅÔºåËØ∑Â§ÑÁêÜÂ§±Ë¥•ÁöÑËßÜÈ¢ë");return}}console.log("[INFO] try to push stream"),l("üì° Ê≠£Âú®ÂêØÂä®Êé®ÊµÅ‚Ä¶");const c=await fetch("/api/stream/start",{method:"POST",headers:{"x-admin-token":n},body:t}),f=await c.text();c.ok?l("‚úÖ Êé®ÊµÅ‰∏≠","ok"):l("‚ùå "+f,"error")}async function Le(){const e=await G(),n=await(await fetch("/api/stream/stop",{method:"POST",headers:{"x-admin-token":e}})).text();l(n)}const Te=1280,Ae=720,be=2*60*60,_e="/stream/ffmpeg";function ke(){return _e}let S,V=!1;async function Pe(){if(!(S||V)){if(!ne()){console.log("[ffmpeg] client transcode not supported, skip preload");return}V=!0,l("‚è≥ ÂàùÂßãÂåñËΩ¨Á†ÅÂºïÊìé‚Ä¶");try{await oe(),l("‚úÖ ËΩ¨Á†ÅÂºïÊìéÂ∞±Áª™")}catch(e){console.warn("[ffmpeg] preload failed",e),l("‚ö†Ô∏è ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅÂÆ¢Êà∑Á´ØËΩ¨Á†Å")}}}async function oe(){if(S)return S;S=new le;const e=ke();return await S.load({coreURL:await z(`${e}/ffmpeg-core.js`,"text/javascript"),wasmURL:await z(`${e}/ffmpeg-core.wasm`,"application/wasm")}),S.on("progress",({progress:t,time:n})=>{if(!P)return;const o=Math.min(99,Math.round(t*100));v(o)}),S.on("error",t=>console.error("[ERROR]",t.message)),S}async function Z(e,t,n){if(e.duration&&e.duration>be)throw new Error("ËßÜÈ¢ëÊñá‰ª∂Â§™Â§ßÔºåËØ∑ÈáçÊñ∞‰∏ä‰º†‰∏çË∂ÖËøá2GÁöÑÊñá‰ª∂„ÄÇ");P=!0,console.log("[INFO] loading ffmpeg");const o=await oe();console.log("[INFO] load ffmpeg success");const r=`input-${Date.now()}.mp4`,s=`output-${Date.now()}.mp4`;v(0,`ÂáÜÂ§áËΩ¨Á†ÅÁ¨¨ ${t+1}/${n} ‰∏™ËßÜÈ¢ë`),await o.writeFile(r,await Ee(e));try{console.log("[INFO] start transcoding..."),await o.exec(["-i",r,"-vf",`scale=${Te}:${Ae}:force_original_aspect_ratio=decrease,format=yuv420p`,"-c:v","libx264","-pix_fmt","yuv420p","-preset","veryfast","-crf","23","-g",String(60),"-keyint_min","30","-sc_threshold","0","-c:a","aac","-strict","experimental","-ar","44100","-ac","2","-b:a","128k","-movflags","+faststart",s])}catch(f){throw console.error("[transcode] ffmpeg failed",f),f}finally{P=!1}let c;try{c=await o.readFile(s)}catch(f){throw console.log(`[ERROR] failed to read transcoded data, error:${f}`),f}if(console.log(`[INFO] transcoding finished, data.length=${c.length}`),!c||c.length===0)throw console.error("[transcode] empty output file",{file:e.name,size:e.size}),new Error("CLIENT_TRANSCODE_EMPTY_OUTPUT");try{await o.unlink(r),await o.unlink(s)}catch(f){console.warn(`[WARN] unlink file failed, error: ${f}`)}return console.log("[INFO] finish transcode"),v(100,"‚úÖ ËΩ¨Á†ÅÂÆåÊàê"),new File([c.buffer],e.name.replace(/\.\w+$/,".mp4"),{type:"video/mp4"})}async function ve(){!S||!P||(console.warn("[ffmpeg] terminate worker"),await S.terminate(),S=null,P=!1,x.textContent="ËΩ¨Á†ÅÂ∑≤ÂèñÊ∂à",ee.style.width="0%",l("‚õî Â∑≤ÂèñÊ∂àËΩ¨Á†Å","info"))}function v(e,t){Q.style.display="block",ee.style.width=`${e}%`,t?x.textContent=t:x.textContent=`ËΩ¨Á†Å‰∏≠‚Ä¶ ${e}%`}function Be(){ge.addEventListener("change",async e=>{Pe();const t=Array.from(e.target.files);if(!t.length)return;let n=!1;for(const o of t){const r=te(o);if(M.has(r))continue;const s=await Ie(o);g.push({originalFile:o,fingerprint:s,transcodeStatus:d.NONE}),M.add(r),n=!0}e.target.value="",n&&y()}),F.addEventListener("change",()=>{F.value==="loop"&&g.length>0?$.classList.remove("hidden"):$.classList.add("hidden")})}document.addEventListener("DOMContentLoaded",()=>{he(),Be()});window.start=Ne;window.stop=Le;window.cancelTranscode=ve;window.removeItem=Se;window.retryTranscode=Re;
