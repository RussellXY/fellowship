# ===== HTTP：只负责跳转 HTTPS =====
  server {
    listen 80;
    server_name fellowship.ledbygrace.live;

    location /.well-known/acme-challenge/ {
      root /usr/share/nginx/html;
    }

    location / {
      return 301 https://$host$request_uri;
    }
  }

  # ===== HTTPS 主站 =====
  server {
    listen 443 ssl;
    server_name fellowship.ledbygrace.live;

    # 允许上传大文件（推流视频）
    client_max_body_size 2g;

    ssl_certificate     /etc/letsencrypt/live/fellowship.ledbygrace.live/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fellowship.ledbygrace.live/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;


    location = /admin {
      auth_basic "Fellowship Admin";
      auth_basic_user_file /etc/nginx/admin.htpasswd;

      root /usr/share/nginx/html;
      try_files /admin.html =404;
    }

    location = /admin/ {
      auth_basic "Fellowship Admin";
      auth_basic_user_file /etc/nginx/admin.htpasswd;

      root /usr/share/nginx/html;
      try_files /admin.html =404;
    }

    location = /admin.html {
      return 404;
    }

    # stream 相关 API（共用同一 Basic Auth）
    location = /api/internal/admin-token {
        auth_basic "Fellowship Admin";
        auth_basic_user_file /etc/nginx/admin.htpasswd;

        proxy_pass http://server:8081;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # 小接口，给足稳定性
        proxy_connect_timeout 10s;
        proxy_read_timeout    10s;
    }

    # ===== Stream API（上传 + 启动 ffmpeg）=====
    location ^~ /api/stream/ {
        auth_basic "Fellowship Admin";
        auth_basic_user_file /etc/nginx/admin.htpasswd;
        
        client_max_body_size 2g;

        # ⚠️ 上传视频必须关 buffering
        proxy_request_buffering off;

        # ⚠️ ffmpeg / IO / Mongo 都慢，必须拉长
        proxy_connect_timeout 300s;
        proxy_send_timeout    300s;
        proxy_read_timeout    300s;

        proxy_pass http://server:8081;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # =====================================================
    # 普通 API（无 Basic Auth，靠 x-admin-token 控制）
    # =====================================================
    location /api/ {
        proxy_request_buffering off;

        proxy_pass http://server:8081;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # =====================================================
    # Stream 管理区（统一 Basic Auth）
    #   - /stream               → 页面
    #   - /api/internal/admin-token → 内部 token
    # =====================================================

    location = /stream {
        return 301 /stream/;
    }

    location ^~ /stream/ {
        auth_basic "Fellowship Admin";
        auth_basic_user_file /etc/nginx/admin.htpasswd;

        root /usr/share/nginx/html;

        # ===== 关键：启用跨源隔离 =====
        add_header Cross-Origin-Opener-Policy same-origin always;
        add_header Cross-Origin-Embedder-Policy require-corp always;

        try_files $uri $uri/ /stream/index.html;
    }

    # ===== ffmpeg wasm / js 必须是纯静态资源 =====
    location ^~ /stream/ffmpeg/ {
        root /usr/share/nginx/html;
        try_files $uri =404;

        # ⚠️ 非常重要：也要带 COOP / COEP
        add_header Cross-Origin-Opener-Policy same-origin always;
        add_header Cross-Origin-Embedder-Policy require-corp always;
    }

    location /ws/ {
      proxy_pass http://server:3001;
      proxy_http_version 1.1;

      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "Upgrade";
      proxy_set_header Host $host;

      # 关闭缓存
      proxy_buffering off;

      # 延长超时（否则会被认为“空闲”）
      proxy_read_timeout 3600s;
      proxy_send_timeout 3600s;
    }

    location /live/ {
      proxy_pass http://172.31.45.177:8080/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location / {
      root /usr/share/nginx/html;
      index index.html;
      try_files $uri $uri/ =404;
    }
  }

  # upload.ledbygrace.live 专门用来文件上传(因CF代理有100M大小限制)
  server {
    listen 443 ssl;
    server_name upload.ledbygrace.live;

    ssl_certificate     /etc/letsencrypt/live/upload.ledbygrace.live/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/upload.ledbygrace.live/privkey.pem;

    # ⚠️ 核心：允许大文件
    client_max_body_size 2g;

    # 只允许 stream API
    location ^~ /api/stream/ {
        proxy_request_buffering off;

        proxy_connect_timeout 300s;
        proxy_send_timeout    300s;
        proxy_read_timeout    300s;

        proxy_pass http://server:8081;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 其他路径全部拒绝（安全）
    location / {
        return 404;
    }
}