var re=Object.defineProperty;var G=t=>{throw TypeError(t)};var se=(t,e,n)=>e in t?re(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var u=(t,e,n)=>se(t,typeof e!="symbol"?e+"":e,n),j=(t,e,n)=>e.has(t)||G("Cannot "+n);var s=(t,e,n)=>(j(t,e,"read from private field"),n?n.call(t):e.get(t)),N=(t,e,n)=>e.has(t)?G("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),_=(t,e,n,o)=>(j(t,e,"write to private field"),o?o.call(t,n):e.set(t,n),n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();var i;(function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.FFPROBE="FFPROBE",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG",t.MOUNT="MOUNT",t.UNMOUNT="UNMOUNT"})(i||(i={}));const ae=(()=>{let t=0;return()=>t++})(),ie=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),ce=new Error("called FFmpeg.terminate()");var m,A,S,T,b,P,p;class le{constructor(){N(this,m,null);N(this,A,{});N(this,S,{});N(this,T,[]);N(this,b,[]);u(this,"loaded",!1);N(this,P,()=>{s(this,m)&&(s(this,m).onmessage=({data:{id:e,type:n,data:o}})=>{switch(n){case i.LOAD:this.loaded=!0,s(this,A)[e](o);break;case i.MOUNT:case i.UNMOUNT:case i.EXEC:case i.FFPROBE:case i.WRITE_FILE:case i.READ_FILE:case i.DELETE_FILE:case i.RENAME:case i.CREATE_DIR:case i.LIST_DIR:case i.DELETE_DIR:s(this,A)[e](o);break;case i.LOG:s(this,T).forEach(r=>r(o));break;case i.PROGRESS:s(this,b).forEach(r=>r(o));break;case i.ERROR:s(this,S)[e](o);break}delete s(this,A)[e],delete s(this,S)[e]})});N(this,p,({type:e,data:n},o=[],r)=>s(this,m)?new Promise((a,c)=>{const E=ae();s(this,m)&&s(this,m).postMessage({id:E,type:e,data:n},o),s(this,A)[E]=a,s(this,S)[E]=c,r==null||r.addEventListener("abort",()=>{c(new DOMException(`Message # ${E} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(ie));u(this,"load",({classWorkerURL:e,...n}={},{signal:o}={})=>(s(this,m)||(_(this,m,e?new Worker(new URL(e,import.meta.url),{type:"module"}):new Worker(new URL("/stream/assets/worker-DYSz7Krg.js",import.meta.url),{type:"module"})),s(this,P).call(this)),s(this,p).call(this,{type:i.LOAD,data:n},void 0,o)));u(this,"exec",(e,n=-1,{signal:o}={})=>s(this,p).call(this,{type:i.EXEC,data:{args:e,timeout:n}},void 0,o));u(this,"ffprobe",(e,n=-1,{signal:o}={})=>s(this,p).call(this,{type:i.FFPROBE,data:{args:e,timeout:n}},void 0,o));u(this,"terminate",()=>{const e=Object.keys(s(this,S));for(const n of e)s(this,S)[n](ce),delete s(this,S)[n],delete s(this,A)[n];s(this,m)&&(s(this,m).terminate(),_(this,m,null),this.loaded=!1)});u(this,"writeFile",(e,n,{signal:o}={})=>{const r=[];return n instanceof Uint8Array&&r.push(n.buffer),s(this,p).call(this,{type:i.WRITE_FILE,data:{path:e,data:n}},r,o)});u(this,"mount",(e,n,o)=>{const r=[];return s(this,p).call(this,{type:i.MOUNT,data:{fsType:e,options:n,mountPoint:o}},r)});u(this,"unmount",e=>{const n=[];return s(this,p).call(this,{type:i.UNMOUNT,data:{mountPoint:e}},n)});u(this,"readFile",(e,n="binary",{signal:o}={})=>s(this,p).call(this,{type:i.READ_FILE,data:{path:e,encoding:n}},void 0,o));u(this,"deleteFile",(e,{signal:n}={})=>s(this,p).call(this,{type:i.DELETE_FILE,data:{path:e}},void 0,n));u(this,"rename",(e,n,{signal:o}={})=>s(this,p).call(this,{type:i.RENAME,data:{oldPath:e,newPath:n}},void 0,o));u(this,"createDir",(e,{signal:n}={})=>s(this,p).call(this,{type:i.CREATE_DIR,data:{path:e}},void 0,n));u(this,"listDir",(e,{signal:n}={})=>s(this,p).call(this,{type:i.LIST_DIR,data:{path:e}},void 0,n));u(this,"deleteDir",(e,{signal:n}={})=>s(this,p).call(this,{type:i.DELETE_DIR,data:{path:e}},void 0,n))}on(e,n){e==="log"?s(this,T).push(n):e==="progress"&&s(this,b).push(n)}off(e,n){e==="log"?_(this,T,s(this,T).filter(o=>o!==n)):e==="progress"&&_(this,b,s(this,b).filter(o=>o!==n))}}m=new WeakMap,A=new WeakMap,S=new WeakMap,T=new WeakMap,b=new WeakMap,P=new WeakMap,p=new WeakMap;var H;(function(t){t.MEMFS="MEMFS",t.NODEFS="NODEFS",t.NODERAWFS="NODERAWFS",t.IDBFS="IDBFS",t.WORKERFS="WORKERFS",t.PROXYFS="PROXYFS"})(H||(H={}));const de=new Error("failed to get response body reader"),fe=new Error("failed to complete download"),ue="Content-Length",pe=t=>new Promise((e,n)=>{const o=new FileReader;o.onload=()=>{const{result:r}=o;r instanceof ArrayBuffer?e(new Uint8Array(r)):e(new Uint8Array)},o.onerror=r=>{var a,c;n(Error(`File could not be read! Code=${((c=(a=r==null?void 0:r.target)==null?void 0:a.error)==null?void 0:c.code)||-1}`))},o.readAsArrayBuffer(t)}),Ee=async t=>{let e;if(typeof t=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(t)?e=atob(t.split(",")[1]).split("").map(n=>n.charCodeAt(0)):e=await(await fetch(t)).arrayBuffer();else if(t instanceof URL)e=await(await fetch(t)).arrayBuffer();else if(t instanceof File||t instanceof Blob)e=await pe(t);else return new Uint8Array;return new Uint8Array(e)},me=async(t,e)=>{var r;const n=await fetch(t);let o;try{const a=parseInt(n.headers.get(ue)||"-1"),c=(r=n.body)==null?void 0:r.getReader();if(!c)throw de;const E=[];let l=0;for(;;){const{done:h,value:w}=await c.read(),y=w?w.length:0;if(h){if(a!=-1&&a!==l)throw fe;e&&e({url:t,total:a,received:l,delta:y,done:h});break}E.push(w),l+=y,e&&e({url:t,total:a,received:l,delta:y,done:h})}const f=new Uint8Array(l);let R=0;for(const h of E)f.set(h,R),R+=h.length;o=f.buffer}catch(a){console.log("failed to send download progress event: ",a),o=await n.arrayBuffer()}return o},K=async(t,e,n=!1,o)=>{const r=n?await me(t,o):await(await fetch(t)).arrayBuffer(),a=new Blob([r],{type:e});return URL.createObjectURL(a)},Q=document.getElementById("transcodeStatus"),$=document.getElementById("transcodeText"),V=document.getElementById("transcodeBar"),D={NONE:"none",TRANSCODING:"doing",DONE:"done"};console.log("[DEBUG]",{crossOriginIsolated:window.crossOriginIsolated,sab:typeof SharedArrayBuffer,location:location.href});let C=null,I=null,k=!1;function he(){if(I&&I.readyState===WebSocket.OPEN)return;const e=`${location.protocol==="https:"?"wss":"ws"}://${location.host}/ws/stream`;I=new WebSocket(e);let n=null;I.onopen=()=>{n=setInterval(()=>{I.readyState===WebSocket.OPEN&&I.send(JSON.stringify({type:"keepalive"}))},25e3),console.log("[WS] stream connected")},I.onclose=()=>{clearInterval(n),console.warn("[WS] stream disconnected")},I.onerror=o=>{clearInterval(n),console.warn("[WS] stream error",o)},I.onmessage=o=>{let r;try{r=JSON.parse(o.data)}catch{console.warn("[WARN] failed to parse websocket message");return}console.log("receive info message"),r.type==="stream-status"&&(r.status==="error"&&d("‚ùå Êé®ÊµÅÂá∫ÈîôÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò","error"),r.status==="stopped"&&d("‚èπ Êé®ÊµÅÂ∑≤ÁªìÊùü","info"),r.status==="running"&&d("‚úÖ Êé®ÊµÅ‰∏≠","ok"),r.status==="info"&&d(`${r.message}`,"info"))}}async function M(){if(C)return C;const t=await fetch("/api/internal/admin-token");if(!t.ok)throw new Error("Êó†Ê≥ïËé∑Âèñ admin token");return C=(await t.json()).token,C}const g=[],x=new Set,X=document.getElementById("playlist"),z=document.getElementById("emptyTip"),J=document.getElementById("status"),v=document.getElementById("mode"),F=document.getElementById("loopSelector"),W=document.getElementById("loopTarget"),we=document.getElementById("fileInput");function ee(t){return`${t.name}|${t.size}|${t.lastModified}`}function ge(t){return(t/1024/1024).toFixed(1)+" MB"}function d(t,e=""){J.textContent=t,J.className="status "+e}function L(){if(X.innerHTML="",W.innerHTML="",g.length===0){z.style.display="block",F.classList.add("hidden");return}z.style.display="none",g.forEach((t,e)=>{const n=t.originalFile;let o="",r="";t.transcodeStatus===D.DONE?(o="‚úÖ Â∑≤ËΩ¨Á†Å",r="ok"):t.transcodeStatus===D.TRANSCODING&&(o="‚è≥ Ê≠£Âú®ËΩ¨Á†Å",r="info");const a=document.createElement("li");a.innerHTML=`
      <span>
        ${e+1}. ${n.name}
        <span class="small">(${ge(n.size)})</span>
        ${o?`<span class="small ${r}" style="margin-left:8px;">${o}</span>`:""}
      </span>
      <button onclick="removeItem(${e})">ÁßªÈô§</button>
    `,X.appendChild(a);const c=document.createElement("option");c.value=e,c.textContent=n.name,W.appendChild(c)}),v.value==="loop"&&F.classList.remove("hidden")}function Re(t){const n=g[t].originalFile;x.delete(ee(n)),g.splice(t,1),L()}async function ye(t){const e=await t.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",e);return[...new Uint8Array(n)].map(o=>o.toString(16).padStart(2,"0")).join("")}async function Y(t){const e=await M(),n=await fetch("/api/stream/check",{method:"POST",headers:{"Content-Type":"application/json","x-admin-token":e},body:JSON.stringify({fingerprint:t})});return n.ok?await n.json():null}function Oe(){Q.style.display="none"}function te(){const t=navigator.userAgent;if(/^((?!chrome|android).)*safari/i.test(t))return!1;let n=!1;try{n=typeof SharedArrayBuffer<"u"}catch{n=!1}return!Ie()&&n&&"Worker"in window}function Ie(){return/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)}async function De(){if(g.length===0){d("‚ùå Êí≠ÊîæÂàóË°®‰∏∫Á©∫","error");return}const t=v.value,e=new FormData;d("‚è≥ ÂáÜÂ§áÊé®ÊµÅ‚Ä¶");const n=await M(),o=te();d(o?"üñ•Ô∏è Ê°åÈù¢ÁéØÂ¢ÉÔºå‰ΩøÁî®ÂÆ¢Êà∑Á´ØËΩ¨Á†Å‚Ä¶":"üì± ÁßªÂä®Á´ØÊàñ‰∏çÊîØÊåÅËΩ¨Á†ÅÔºå‰ΩøÁî®ÊúçÂä°Âô®ËΩ¨Á†Å‚Ä¶");const r=[],a=[];if(t==="loop"){const l=Number(W.value),f=g[l],R=f.originalFile,h=f.fingerprint,w=await Y(h);if(w!=null&&w.exists)a.push({filePath:w.path,index:l}),f.transcodeStatus=D.DONE,L();else{if(!o){d("‚ùå ÂΩìÂâçÁéØÂ¢É‰∏çÊîØÊåÅÂÆ¢Êà∑Á´ØËΩ¨Á†Å","error");return}console.log("[INFO] ÂºÄÂßãËΩ¨Á†Å..."),B(0,"ÂáÜÂ§áËΩ¨Á†ÅÁ¨¨ 1 / 1 ‰∏™ËßÜÈ¢ë"),f.transcodeStatus=D.TRANSCODING,L();const y=await Z(R,0,1);r.push({file:y,fingerprint:h,index:l}),f.transcodeStatus=D.DONE,L()}e.append("loopIndex",l)}else{const l=g.length;for(let f=0;f<g.length;f++){const R=g[f],h=R.originalFile,w=R.fingerprint,y=await Y(w);if(y!=null&&y.exists){a.push({filePath:y.path,index:f}),R.transcodeStatus=D.DONE,L();continue}if(!o){d("‚ùå ÂΩìÂâçÁéØÂ¢É‰∏çÊîØÊåÅÂÆ¢Êà∑Á´ØËΩ¨Á†Å","error");return}B(0,`ÂáÜÂ§áËΩ¨Á†ÅÁ¨¨ ${f+1} / ${l} ‰∏™ËßÜÈ¢ëÔºö${h.name}`),R.transcodeStatus=D.TRANSCODING,L(),console.log("[INFO] ÂºÄÂßãËΩ¨Á†Å...");const oe=await Z(h,f,l);r.push({file:oe,fingerprint:w,index:f}),R.transcodeStatus=D.DONE,L()}}for(const l of a)e.append("existing",JSON.stringify(l));for(const l of r)e.append("files",l.file,l.file.name),e.append("fingerprints",l.fingerprint);r.length>0&&e.append("clientTranscoded","1"),e.append("mode",t),Oe(),d("üì° Ê≠£Âú®ÂêØÂä®Êé®ÊµÅ‚Ä¶");const c=await fetch("/api/stream/start",{method:"POST",headers:{"x-admin-token":n},body:e}),E=await c.text();c.ok?d("‚úÖ Êé®ÊµÅ‰∏≠","ok"):d("‚ùå "+E,"error")}async function Se(){const t=await M(),n=await(await fetch("/api/stream/stop",{method:"POST",headers:{"x-admin-token":t}})).text();d(n)}const Ne=1280,Le=720,U=30,Ae=2*60*60,Te="/stream/ffmpeg";function be(){return Te}let O,q=!1;async function _e(){if(!(O||q)){if(!te()){console.log("[ffmpeg] client transcode not supported, skip preload");return}q=!0,d("‚è≥ ÂàùÂßãÂåñËΩ¨Á†ÅÂºïÊìé‚Ä¶");try{await ne(),d("‚úÖ ËΩ¨Á†ÅÂºïÊìéÂ∞±Áª™")}catch(t){console.warn("[ffmpeg] preload failed",t),d("‚ö†Ô∏è ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅÂÆ¢Êà∑Á´ØËΩ¨Á†Å")}}}async function ne(){if(O)return O;O=new le;const t=be();return await O.load({coreURL:await K(`${t}/ffmpeg-core.js`,"text/javascript"),wasmURL:await K(`${t}/ffmpeg-core.wasm`,"application/wasm")}),O.on("progress",({progress:e,time:n})=>{if(!k)return;const o=Math.min(99,Math.round(e*100));B(o)}),O}async function Z(t,e,n){if(t.duration&&t.duration>Ae)throw new Error("ËßÜÈ¢ëÊñá‰ª∂Â§™Â§ßÔºåËØ∑ÈáçÊñ∞‰∏ä‰º†‰∏çË∂ÖËøá2GÁöÑÊñá‰ª∂„ÄÇ");k=!0,console.log("[INFO] loading ffmpeg");const o=await ne();console.log("[INFO] load ffmpeg success");const r=`input-${Date.now()}.mp4`,a=`output-${Date.now()}.mp4`;B(0,`ÂáÜÂ§áËΩ¨Á†ÅÁ¨¨ ${e+1}/${n} ‰∏™ËßÜÈ¢ë`),await o.writeFile(r,await Ee(t));try{console.log("[INFO] start transcoding..."),await o.exec(["-i",r,"-vf",`scale=${Ne}:${Le}:force_original_aspect_ratio=decrease,fps=${U}`,"-c:v","libx264","-pix_fmt","yuv420p","-preset","veryfast","-crf","24","-g",String(U*2),"-keyint_min",String(U),"-sc_threshold","0","-c:a","aac","-ar","44100","-ac","2","-b:a","128k","-movflags","+faststart",a])}catch(E){throw E.name==="AbortError"?(console.warn("[transcode] cancelled by user"),new Error("CLIENT_TRANSCODE_CANCELLED")):(console.error("[transcode] ffmpeg failed",E),new Error("CLIENT_TRANSCODE_FAILED"))}finally{k=!1}const c=await o.readFile(a);try{await o.unlink(r),await o.unlink(a)}catch(E){console.warn(`[WARN] unlink file failed, error: ${E}`)}return console.log("[INFO] finish transcode"),B(100,"‚úÖ ËΩ¨Á†ÅÂÆåÊàê"),new File([c.buffer],t.name.replace(/\.\w+$/,".mp4"),{type:"video/mp4"})}async function ke(){!O||!k||(console.warn("[ffmpeg] terminate worker"),await O.terminate(),O=null,k=!1,$.textContent="ËΩ¨Á†ÅÂ∑≤ÂèñÊ∂à",V.style.width="0%",d("‚õî Â∑≤ÂèñÊ∂àËΩ¨Á†Å","info"))}function B(t,e){Q.style.display="block",V.style.width=`${t}%`,e?$.textContent=e:$.textContent=`ËΩ¨Á†Å‰∏≠‚Ä¶ ${t}%`}function Be(){we.addEventListener("change",async t=>{_e();const e=Array.from(t.target.files);if(!e.length)return;let n=!1;for(const o of e){const r=ee(o);if(x.has(r))continue;const a=await ye(o);g.push({originalFile:o,fingerprint:a,transcodeStatus:D.NONE}),x.add(r),n=!0}t.target.value="",n&&L()}),v.addEventListener("change",()=>{v.value==="loop"&&g.length>0?F.classList.remove("hidden"):F.classList.add("hidden")})}document.addEventListener("DOMContentLoaded",()=>{he(),Be()});window.start=De;window.stop=Se;window.cancelTranscode=ke;window.removeItem=Re;
