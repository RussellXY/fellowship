var ae=Object.defineProperty;var j=e=>{throw TypeError(e)};var ie=(e,t,n)=>t in e?ae(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var m=(e,t,n)=>ie(e,typeof t!="symbol"?t+"":t,n),z=(e,t,n)=>t.has(e)||j("Cannot "+n);var a=(e,t,n)=>(z(e,t,"read from private field"),n?n.call(e):t.get(e)),N=(e,t,n)=>t.has(e)?j("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),_=(e,t,n,o)=>(z(e,t,"write to private field"),o?o.call(e,n):t.set(e,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();var i;(function(e){e.LOAD="LOAD",e.EXEC="EXEC",e.FFPROBE="FFPROBE",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.RENAME="RENAME",e.CREATE_DIR="CREATE_DIR",e.LIST_DIR="LIST_DIR",e.DELETE_DIR="DELETE_DIR",e.ERROR="ERROR",e.DOWNLOAD="DOWNLOAD",e.PROGRESS="PROGRESS",e.LOG="LOG",e.MOUNT="MOUNT",e.UNMOUNT="UNMOUNT"})(i||(i={}));const ce=(()=>{let e=0;return()=>e++})(),le=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),de=new Error("called FFmpeg.terminate()");var w,L,D,T,b,U,h;class fe{constructor(){N(this,w,null);N(this,L,{});N(this,D,{});N(this,T,[]);N(this,b,[]);m(this,"loaded",!1);N(this,U,()=>{a(this,w)&&(a(this,w).onmessage=({data:{id:t,type:n,data:o}})=>{switch(n){case i.LOAD:this.loaded=!0,a(this,L)[t](o);break;case i.MOUNT:case i.UNMOUNT:case i.EXEC:case i.FFPROBE:case i.WRITE_FILE:case i.READ_FILE:case i.DELETE_FILE:case i.RENAME:case i.CREATE_DIR:case i.LIST_DIR:case i.DELETE_DIR:a(this,L)[t](o);break;case i.LOG:a(this,T).forEach(r=>r(o));break;case i.PROGRESS:a(this,b).forEach(r=>r(o));break;case i.ERROR:a(this,D)[t](o);break}delete a(this,L)[t],delete a(this,D)[t]})});N(this,h,({type:t,data:n},o=[],r)=>a(this,w)?new Promise((s,c)=>{const d=ce();a(this,w)&&a(this,w).postMessage({id:d,type:t,data:n},o),a(this,L)[d]=s,a(this,D)[d]=c,r==null||r.addEventListener("abort",()=>{c(new DOMException(`Message # ${d} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(le));m(this,"load",({classWorkerURL:t,...n}={},{signal:o}={})=>(a(this,w)||(_(this,w,t?new Worker(new URL(t,import.meta.url),{type:"module"}):new Worker(new URL("/stream/assets/worker-DYSz7Krg.js",import.meta.url),{type:"module"})),a(this,U).call(this)),a(this,h).call(this,{type:i.LOAD,data:n},void 0,o)));m(this,"exec",(t,n=-1,{signal:o}={})=>a(this,h).call(this,{type:i.EXEC,data:{args:t,timeout:n}},void 0,o));m(this,"ffprobe",(t,n=-1,{signal:o}={})=>a(this,h).call(this,{type:i.FFPROBE,data:{args:t,timeout:n}},void 0,o));m(this,"terminate",()=>{const t=Object.keys(a(this,D));for(const n of t)a(this,D)[n](de),delete a(this,D)[n],delete a(this,L)[n];a(this,w)&&(a(this,w).terminate(),_(this,w,null),this.loaded=!1)});m(this,"writeFile",(t,n,{signal:o}={})=>{const r=[];return n instanceof Uint8Array&&r.push(n.buffer),a(this,h).call(this,{type:i.WRITE_FILE,data:{path:t,data:n}},r,o)});m(this,"mount",(t,n,o)=>{const r=[];return a(this,h).call(this,{type:i.MOUNT,data:{fsType:t,options:n,mountPoint:o}},r)});m(this,"unmount",t=>{const n=[];return a(this,h).call(this,{type:i.UNMOUNT,data:{mountPoint:t}},n)});m(this,"readFile",(t,n="binary",{signal:o}={})=>a(this,h).call(this,{type:i.READ_FILE,data:{path:t,encoding:n}},void 0,o));m(this,"deleteFile",(t,{signal:n}={})=>a(this,h).call(this,{type:i.DELETE_FILE,data:{path:t}},void 0,n));m(this,"rename",(t,n,{signal:o}={})=>a(this,h).call(this,{type:i.RENAME,data:{oldPath:t,newPath:n}},void 0,o));m(this,"createDir",(t,{signal:n}={})=>a(this,h).call(this,{type:i.CREATE_DIR,data:{path:t}},void 0,n));m(this,"listDir",(t,{signal:n}={})=>a(this,h).call(this,{type:i.LIST_DIR,data:{path:t}},void 0,n));m(this,"deleteDir",(t,{signal:n}={})=>a(this,h).call(this,{type:i.DELETE_DIR,data:{path:t}},void 0,n))}on(t,n){t==="log"?a(this,T).push(n):t==="progress"&&a(this,b).push(n)}off(t,n){t==="log"?_(this,T,a(this,T).filter(o=>o!==n)):t==="progress"&&_(this,b,a(this,b).filter(o=>o!==n))}}w=new WeakMap,L=new WeakMap,D=new WeakMap,T=new WeakMap,b=new WeakMap,U=new WeakMap,h=new WeakMap;var H;(function(e){e.MEMFS="MEMFS",e.NODEFS="NODEFS",e.NODERAWFS="NODERAWFS",e.IDBFS="IDBFS",e.WORKERFS="WORKERFS",e.PROXYFS="PROXYFS"})(H||(H={}));const ue=new Error("failed to get response body reader"),pe=new Error("failed to complete download"),Ee="Content-Length",me=e=>new Promise((t,n)=>{const o=new FileReader;o.onload=()=>{const{result:r}=o;r instanceof ArrayBuffer?t(new Uint8Array(r)):t(new Uint8Array)},o.onerror=r=>{var s,c;n(Error(`File could not be read! Code=${((c=(s=r==null?void 0:r.target)==null?void 0:s.error)==null?void 0:c.code)||-1}`))},o.readAsArrayBuffer(e)}),he=async e=>{let t;if(typeof e=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(e)?t=atob(e.split(",")[1]).split("").map(n=>n.charCodeAt(0)):t=await(await fetch(e)).arrayBuffer();else if(e instanceof URL)t=await(await fetch(e)).arrayBuffer();else if(e instanceof File||e instanceof Blob)t=await me(e);else return new Uint8Array;return new Uint8Array(t)},ge=async(e,t)=>{var r;const n=await fetch(e);let o;try{const s=parseInt(n.headers.get(Ee)||"-1"),c=(r=n.body)==null?void 0:r.getReader();if(!c)throw ue;const d=[];let A=0;for(;;){const{done:u,value:S}=await c.read(),R=S?S.length:0;if(u){if(s!=-1&&s!==A)throw pe;t&&t({url:e,total:s,received:A,delta:R,done:u});break}d.push(S),A+=R,t&&t({url:e,total:s,received:A,delta:R,done:u})}const p=new Uint8Array(A);let E=0;for(const u of d)p.set(u,E),E+=u.length;o=p.buffer}catch(s){console.log("failed to send download progress event: ",s),o=await n.arrayBuffer()}return o},X=async(e,t,n=!1,o)=>{const r=n?await ge(e,o):await(await fetch(e)).arrayBuffer(),s=new Blob([r],{type:t});return URL.createObjectURL(s)},te=document.getElementById("transcodeStatus"),M=document.getElementById("transcodeText"),ne=document.getElementById("transcodeBar"),f={NONE:"none",TRANSCODING:"doing",DONE:"done",ERROR:"error",SKIPPED:"skipped"};console.log("[DEBUG]",{crossOriginIsolated:window.crossOriginIsolated,sab:typeof SharedArrayBuffer,location:location.href});let v=null,I=null,B=!1;function we(){if(I&&I.readyState===WebSocket.OPEN)return;const t=`${location.protocol==="https:"?"wss":"ws"}://${location.host}/ws/stream`;I=new WebSocket(t);let n=null;I.onopen=()=>{n=setInterval(()=>{I.readyState===WebSocket.OPEN&&I.send(JSON.stringify({type:"keepalive"}))},25e3),console.log("[WS] stream connected")},I.onclose=()=>{clearInterval(n),console.warn("[WS] stream disconnected")},I.onerror=o=>{clearInterval(n),console.warn("[WS] stream error",o)},I.onmessage=o=>{let r;try{r=JSON.parse(o.data)}catch{console.warn("[WARN] failed to parse websocket message");return}console.log("receive info message"),r.type==="stream-status"&&(r.status==="error"&&l("‚ùå Êé®ÊµÅÂá∫ÈîôÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò","error"),r.status==="stopped"&&l("‚èπ Êé®ÊµÅÂ∑≤ÁªìÊùü","info"),r.status==="running"&&l("‚úÖ Êé®ÊµÅ‰∏≠","ok"),r.status==="info"&&l(`${r.message}`,"info"))}}async function K(){if(v)return v;const e=await fetch("/api/internal/admin-token");if(!e.ok)throw new Error("Êó†Ê≥ïËé∑Âèñ admin token");return v=(await e.json()).token,v}const g=[],W=new Set,Y=document.getElementById("playlist"),J=document.getElementById("emptyTip"),q=document.getElementById("status"),$=document.getElementById("mode"),C=document.getElementById("loopSelector"),G=document.getElementById("loopTarget"),Re=document.getElementById("fileInput");function oe(e){return`${e.name}|${e.size}|${e.lastModified}`}function Oe(e){return(e/1024/1024).toFixed(1)+" MB"}function l(e,t=""){q.textContent=e,q.className="status "+t}function y(){if(Y.innerHTML="",G.innerHTML="",g.length===0){J.style.display="block",C.classList.add("hidden");return}J.style.display="none",g.forEach((e,t)=>{const n=e.originalFile;let o="",r="";e.transcodeStatus===f.DONE||e.transcodeStatus===f.SKIPPED?(o="‚úÖ Â∑≤ËΩ¨Á†Å",r="ok"):e.transcodeStatus===f.TRANSCODING?(o="‚è≥ Ê≠£Âú®ËΩ¨Á†Å",r="info"):e.transcodeStatus===f.ERROR&&(o="‚ùå ËΩ¨Á†ÅÂ§±Ë¥•",r="error");let s=`<button onclick="removeItem(${t})">ÁßªÈô§</button>`;e.transcodeStatus===f.ERROR&&(s=`
                <button onclick="retryTranscode(${t})">üîÅ ÈáçËØï</button>
                <button onclick="removeItem(${t})">ÁßªÈô§</button>
            `);const c=document.createElement("li");c.innerHTML=`
            <span>
                ${t+1}. ${n.name}
                <span class="small">(${Oe(n.size)})</span>
                ${o?`<span class="small ${r}" style="margin-left:8px;">${o}</span>`:""}
            </span>
            ${s}
            `,Y.appendChild(c);const d=document.createElement("option");d.value=t,d.textContent=n.name,G.appendChild(d)}),$.value==="loop"&&C.classList.remove("hidden")}async function ye(e){const t=g[e];t&&(t.transcodeStatus=f.NONE,y(),l(`üîÅ Â∑≤ÈáçÁΩÆËΩ¨Á†ÅÁä∂ÊÄÅÔºö${t.originalFile.name}`))}function Se(){return g.some(e=>e.transcodeStatus===f.ERROR)}function Ie(){return g.some(e=>e.transcodeStatus===f.DONE||e.transcodeStatus===f.SKIPPED)}function De(e){const n=g[e].originalFile;W.delete(oe(n)),g.splice(e,1),y()}async function Ne(e){const t=await e.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",t);return[...new Uint8Array(n)].map(o=>o.toString(16).padStart(2,"0")).join("")}async function V(e){const t=await K(),n=await fetch("/api/stream/check",{method:"POST",headers:{"Content-Type":"application/json","x-admin-token":t},body:JSON.stringify({fingerprint:e})});return n.ok?await n.json():null}function Z(){te.style.display="none"}function re(){const e=navigator.userAgent;if(/^((?!chrome|android).)*safari/i.test(e))return!1;let n=!1;try{n=typeof SharedArrayBuffer<"u"}catch{n=!1}return!Le()&&n&&"Worker"in window}function Le(){return/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)}async function Ae(){if(g.length===0){l("‚ùå Êí≠ÊîæÂàóË°®‰∏∫Á©∫","error");return}const e=$.value,t=new FormData;l("‚è≥ ÂáÜÂ§áÊé®ÊµÅ‚Ä¶");const n=await K(),o=re();l(o?"üñ•Ô∏è Ê°åÈù¢ÁéØÂ¢ÉÔºå‰ΩøÁî®ÂÆ¢Êà∑Á´ØËΩ¨Á†Å‚Ä¶":"üì± ÁßªÂä®Á´ØÊàñ‰∏çÊîØÊåÅËΩ¨Á†ÅÔºå‰ΩøÁî®ÊúçÂä°Âô®ËΩ¨Á†Å‚Ä¶");const r=[],s=[];let c=!1;if(e==="loop"){const p=Number(G.value),E=g[p],u=E.originalFile,S=E.fingerprint,R=await V(S);if(R!=null&&R.exists)s.push({filePath:R.path,index:p}),E.transcodeStatus=f.DONE,y();else{if(!o){l("‚ùå ÂΩìÂâçÁéØÂ¢É‰∏çÊîØÊåÅÂÆ¢Êà∑Á´ØËΩ¨Á†Å","error");return}console.log("[INFO] ÂºÄÂßãËΩ¨Á†Å..."),F(0,"ÂáÜÂ§áËΩ¨Á†ÅÁ¨¨ 1 / 1 ‰∏™ËßÜÈ¢ë"),E.transcodeStatus=f.TRANSCODING,y();const P=await ee(u,0,1);r.push({file:P,fingerprint:S,index:p}),E.transcodeStatus=f.DONE,y()}t.append("loopIndex",p)}else{const p=g.length;for(let E=0;E<g.length;E++){const u=g[E];if(u.transcodeStatus===f.DONE||u.transcodeStatus===f.SKIPPED){u.transcodeStatus=f.SKIPPED;continue}if(u.transcodeStatus===f.ERROR)continue;const S=u.originalFile,R=u.fingerprint,P=await V(R);if(P!=null&&P.exists){s.push({filePath:P.path,index:E}),u.transcodeStatus=f.DONE,y();continue}if(!o){l("‚ùå ÂΩìÂâçÁéØÂ¢É‰∏çÊîØÊåÅÂÆ¢Êà∑Á´ØËΩ¨Á†Å","error");return}F(0,`ÂáÜÂ§áËΩ¨Á†ÅÁ¨¨ ${E+1} / ${p} ‰∏™ËßÜÈ¢ëÔºö${S.name}`),u.transcodeStatus=f.TRANSCODING,y(),console.log("[INFO] ÂºÄÂßãËΩ¨Á†Å...");try{const k=await ee(S,E,p);r.push({file:k,fingerprint:R,index:E}),u.transcodeStatus=f.DONE,y()}catch(k){String(k==null?void 0:k.message).includes("called FFmpeg.terminate()")?(c=!0,u.transcodeStatus=f.NONE):u.transcodeStatus=f.ERROR,Z(),y();continue}}}if(s.length==0&&r.length==0){c?l("ËΩ¨Á†ÅÂèñÊ∂à"):l("Êñá‰ª∂ËΩ¨Á†ÅÂ§±Ë¥•","error");return}for(const p of s)t.append("existing",JSON.stringify(p));for(const p of r)t.append("files",p.file,p.file.name),t.append("fingerprints",p.fingerprint);if(r.length>0&&t.append("clientTranscoded","1"),t.append("mode",e),Z(),Se()){if(!Ie()){alert("‚ùå ÊâÄÊúâËßÜÈ¢ëÂùáËΩ¨Á†ÅÂ§±Ë¥•ÔºåÊó†Ê≥ïÂºÄÂßãÊé®ÊµÅ"),l("‚ùå ËΩ¨Á†ÅÂ§±Ë¥•ÔºåËØ∑Â§ÑÁêÜÂêéÈáçËØï","error");return}if(l("‚ö†Ô∏è ËΩ¨Á†ÅÂÆåÊàêÔºåÂ≠òÂú®Â§±Ë¥•ËßÜÈ¢ëÔºåÁ≠âÂæÖÁ°ÆËÆ§‚Ä¶"),!window.confirm(`‚ö†Ô∏è ÊúâËßÜÈ¢ëËΩ¨Á†ÅÂ§±Ë¥•„ÄÇ

ÁÇπÂáª„ÄåÁ°ÆÂÆö„ÄçÂ∞ÜÂøΩÁï•Â§±Ë¥•ÁöÑËßÜÈ¢ëÔºå‰ªÖÊé®ÊµÅÂ∑≤ËΩ¨Á†ÅÊàêÂäüÁöÑÂÜÖÂÆπ„ÄÇ
ÁÇπÂáª„ÄåÂèñÊ∂à„ÄçËøîÂõûÂ§ÑÁêÜÂ§±Ë¥•ËßÜÈ¢ëÔºàÈáçËØïÊàñÁßªÈô§Ôºâ„ÄÇ`)){l("‚è∏ Â∑≤ÂèñÊ∂àÊé®ÊµÅÔºåËØ∑Â§ÑÁêÜÂ§±Ë¥•ÁöÑËßÜÈ¢ë");return}}console.log("[INFO] try to push stream"),l("üì° Ê≠£Âú®ÂêØÂä®Êé®ÊµÅ‚Ä¶");const d=await fetch("/api/stream/start",{method:"POST",headers:{"x-admin-token":n},body:t}),A=await d.text();d.ok?l("‚úÖ Êé®ÊµÅ‰∏≠","ok"):l("‚ùå "+A,"error")}async function Te(){const e=await K(),n=await(await fetch("/api/stream/stop",{method:"POST",headers:{"x-admin-token":e}})).text();l(n)}const x=30,be=2*60*60,Pe="/stream/ffmpeg";function ke(){return Pe}let O,Q=!1;async function _e(){if(!(O||Q)){if(!re()){console.log("[ffmpeg] client transcode not supported, skip preload");return}Q=!0,l("‚è≥ ÂàùÂßãÂåñËΩ¨Á†ÅÂºïÊìé‚Ä¶");try{await se(),l("‚úÖ ËΩ¨Á†ÅÂºïÊìéÂ∞±Áª™")}catch(e){console.warn("[ffmpeg] preload failed",e),l("‚ö†Ô∏è ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅÂÆ¢Êà∑Á´ØËΩ¨Á†Å")}}}async function se(){if(O)return O;O=new fe;const e=ke();return await O.load({coreURL:await X(`${e}/ffmpeg-core.js`,"text/javascript"),wasmURL:await X(`${e}/ffmpeg-core.wasm`,"application/wasm")}),O.on("progress",({progress:t,time:n})=>{if(!B)return;const o=Math.min(99,Math.round(t*100));F(o)}),O.on("error",t=>console.error("[ERROR]",t.message)),O}async function ee(e,t,n){if(e.duration&&e.duration>be)throw new Error("ËßÜÈ¢ëÊñá‰ª∂Â§™Â§ßÔºåËØ∑ÈáçÊñ∞‰∏ä‰º†‰∏çË∂ÖËøá2GÁöÑÊñá‰ª∂„ÄÇ");B=!0,console.log("[INFO] loading ffmpeg");const o=await se();console.log("[INFO] load ffmpeg success");const r=`input-${Date.now()}.mp4`,s=`output-${Date.now()}.mp4`;F(0,`ÂáÜÂ§áËΩ¨Á†ÅÁ¨¨ ${t+1}/${n} ‰∏™ËßÜÈ¢ë`),await o.writeFile(r,await he(e));try{console.log("[INFO] start transcoding..."),await o.exec(["-i",r,"-vf",`fps=${x},format=yuv420p`,"-c:v","libx264","-pix_fmt","yuv420p","-preset","veryfast","-crf","24","-g",String(x*2),"-keyint_min",String(x),"-sc_threshold","0","-c:a","aac","-ar","44100","-ac","2","-b:a","128k","-movflags","+faststart",s])}catch(d){throw console.error("[transcode] ffmpeg failed",d),d}finally{B=!1}let c;try{c=await o.readFile(s)}catch(d){throw console.log(`[ERROR] failed to read transcoded data, error:${d}`),d}if(console.log(`[INFO] transcoding finished, data.length=${c.length}`),!c||c.length===0)throw console.error("[transcode] empty output file",{file:e.name,size:e.size}),new Error("CLIENT_TRANSCODE_EMPTY_OUTPUT");try{await o.unlink(r),await o.unlink(s)}catch(d){console.warn(`[WARN] unlink file failed, error: ${d}`)}return console.log("[INFO] finish transcode"),F(100,"‚úÖ ËΩ¨Á†ÅÂÆåÊàê"),new File([c.buffer],e.name.replace(/\.\w+$/,".mp4"),{type:"video/mp4"})}async function Be(){!O||!B||(console.warn("[ffmpeg] terminate worker"),await O.terminate(),O=null,B=!1,M.textContent="ËΩ¨Á†ÅÂ∑≤ÂèñÊ∂à",ne.style.width="0%",l("‚õî Â∑≤ÂèñÊ∂àËΩ¨Á†Å","info"))}function F(e,t){te.style.display="block",ne.style.width=`${e}%`,t?M.textContent=t:M.textContent=`ËΩ¨Á†Å‰∏≠‚Ä¶ ${e}%`}function Fe(){Re.addEventListener("change",async e=>{_e();const t=Array.from(e.target.files);if(!t.length)return;let n=!1;for(const o of t){const r=oe(o);if(W.has(r))continue;const s=await Ne(o);g.push({originalFile:o,fingerprint:s,transcodeStatus:f.NONE}),W.add(r),n=!0}e.target.value="",n&&y()}),$.addEventListener("change",()=>{$.value==="loop"&&g.length>0?C.classList.remove("hidden"):C.classList.add("hidden")})}document.addEventListener("DOMContentLoaded",()=>{we(),Fe()});window.start=Ae;window.stop=Te;window.cancelTranscode=Be;window.removeItem=De;window.retryTranscode=ye;
