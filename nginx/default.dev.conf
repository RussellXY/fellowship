server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name fellowship.dev;

    # =========================
    # 基础 SSL
    # =========================
    ssl_certificate     /etc/nginx/certs/fellowship.dev+2.pem;
    ssl_certificate_key /etc/nginx/certs/fellowship.dev+2-key.pem;

    ssl_protocols TLSv1.2 TLSv1.3;

    # =========================
    # 上传大小限制（视频）
    # =========================
    client_max_body_size 2g;

    # =========================
    # 静态资源根目录
    # =========================
    root /usr/share/nginx/html;
    index index.html;

    # =====================================================
    # /admin 页面（仅返回 admin.html，不直接暴露文件）
    # =====================================================
    location = /admin {
        root /usr/share/nginx/html;
        try_files /admin.html =404;
    }

    location = /admin/ {
        root /usr/share/nginx/html;
        try_files /admin.html =404;
    }

    # 禁止直接访问 admin.html
    location = /admin.html {
        return 404;
    }

    # stream 相关 API（共用同一 Basic Auth）
    location = /api/internal/admin-token {
        auth_basic "Fellowship Admin";
        auth_basic_user_file /etc/nginx/admin.htpasswd;

        proxy_pass http://server:8081;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # 小接口，给足稳定性
        proxy_connect_timeout 10s;
        proxy_read_timeout    10s;
    }

    # ===== Stream API（上传 + 启动 ffmpeg）=====
    location ^~ /api/stream/ {
        auth_basic "Fellowship Admin";
        auth_basic_user_file /etc/nginx/admin.htpasswd;
        
        client_max_body_size 2g;

        # ⚠️ 上传视频必须关 buffering
        proxy_request_buffering off;

        # ⚠️ ffmpeg / IO / Mongo 都慢，必须拉长
        proxy_connect_timeout 300s;
        proxy_send_timeout    300s;
        proxy_read_timeout    300s;

        proxy_pass http://server:8081;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # =====================================================
    # 普通 API（无 Basic Auth，靠 x-admin-token 控制）
    # =====================================================
    location /api/ {
        proxy_request_buffering off;

        proxy_pass http://server:8081;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # =====================================================
    # Stream 管理区（统一 Basic Auth）
    #   - /stream               → 页面
    #   - /api/internal/admin-token → 内部 token
    # =====================================================

    location = /stream {
        return 301 /stream/;
    }

    location ^~ /stream/ {
        auth_basic "Fellowship Admin";
        auth_basic_user_file /etc/nginx/admin.htpasswd;

        root /usr/share/nginx/html;

        # ===== 关键：启用跨源隔离 =====
        add_header Cross-Origin-Opener-Policy same-origin always;
        add_header Cross-Origin-Embedder-Policy require-corp always;

        try_files $uri $uri/ /stream/index.html;
    }

    # ===== ffmpeg wasm / js 必须是纯静态资源 =====
    location ^~ /stream/ffmpeg/ {
        root /usr/share/nginx/html;
        try_files $uri =404;

        # ⚠️ 非常重要：也要带 COOP / COEP
        add_header Cross-Origin-Opener-Policy same-origin always;
        add_header Cross-Origin-Embedder-Policy require-corp always;
    }

    # =====================================================
    # WebSocket
    # =====================================================
    location /ws/ {
        proxy_pass http://server:3001;
        proxy_http_version 1.1;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;

        # 关闭缓存
        proxy_buffering off;

        # WebSocket 超时
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # =====================================================
    # 默认前端入口
    # =====================================================
    location / {
        try_files $uri /index.html;
    }
}