var ne=Object.defineProperty;var W=t=>{throw TypeError(t)};var oe=(t,e,n)=>e in t?ne(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var f=(t,e,n)=>oe(t,typeof e!="symbol"?e+"":e,n),M=(t,e,n)=>e.has(t)||W("Cannot "+n);var a=(t,e,n)=>(M(t,e,"read from private field"),n?n.call(t):e.get(t)),L=(t,e,n)=>e.has(t)?W("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),T=(t,e,n,o)=>(M(t,e,"write to private field"),o?o.call(t,n):e.set(t,n),n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const d of s.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();var i;(function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.FFPROBE="FFPROBE",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG",t.MOUNT="MOUNT",t.UNMOUNT="UNMOUNT"})(i||(i={}));const re=(()=>{let t=0;return()=>t++})(),ae=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),se=new Error("called FFmpeg.terminate()");var E,D,I,S,N,F,u;class ie{constructor(){L(this,E,null);L(this,D,{});L(this,I,{});L(this,S,[]);L(this,N,[]);f(this,"loaded",!1);L(this,F,()=>{a(this,E)&&(a(this,E).onmessage=({data:{id:e,type:n,data:o}})=>{switch(n){case i.LOAD:this.loaded=!0,a(this,D)[e](o);break;case i.MOUNT:case i.UNMOUNT:case i.EXEC:case i.FFPROBE:case i.WRITE_FILE:case i.READ_FILE:case i.DELETE_FILE:case i.RENAME:case i.CREATE_DIR:case i.LIST_DIR:case i.DELETE_DIR:a(this,D)[e](o);break;case i.LOG:a(this,S).forEach(r=>r(o));break;case i.PROGRESS:a(this,N).forEach(r=>r(o));break;case i.ERROR:a(this,I)[e](o);break}delete a(this,D)[e],delete a(this,I)[e]})});L(this,u,({type:e,data:n},o=[],r)=>a(this,E)?new Promise((s,d)=>{const p=re();a(this,E)&&a(this,E).postMessage({id:p,type:e,data:n},o),a(this,D)[p]=s,a(this,I)[p]=d,r==null||r.addEventListener("abort",()=>{d(new DOMException(`Message # ${p} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(ae));f(this,"load",({classWorkerURL:e,...n}={},{signal:o}={})=>(a(this,E)||(T(this,E,e?new Worker(new URL(e,import.meta.url),{type:"module"}):new Worker(new URL("/stream/assets/worker-DYSz7Krg.js",import.meta.url),{type:"module"})),a(this,F).call(this)),a(this,u).call(this,{type:i.LOAD,data:n},void 0,o)));f(this,"exec",(e,n=-1,{signal:o}={})=>a(this,u).call(this,{type:i.EXEC,data:{args:e,timeout:n}},void 0,o));f(this,"ffprobe",(e,n=-1,{signal:o}={})=>a(this,u).call(this,{type:i.FFPROBE,data:{args:e,timeout:n}},void 0,o));f(this,"terminate",()=>{const e=Object.keys(a(this,I));for(const n of e)a(this,I)[n](se),delete a(this,I)[n],delete a(this,D)[n];a(this,E)&&(a(this,E).terminate(),T(this,E,null),this.loaded=!1)});f(this,"writeFile",(e,n,{signal:o}={})=>{const r=[];return n instanceof Uint8Array&&r.push(n.buffer),a(this,u).call(this,{type:i.WRITE_FILE,data:{path:e,data:n}},r,o)});f(this,"mount",(e,n,o)=>{const r=[];return a(this,u).call(this,{type:i.MOUNT,data:{fsType:e,options:n,mountPoint:o}},r)});f(this,"unmount",e=>{const n=[];return a(this,u).call(this,{type:i.UNMOUNT,data:{mountPoint:e}},n)});f(this,"readFile",(e,n="binary",{signal:o}={})=>a(this,u).call(this,{type:i.READ_FILE,data:{path:e,encoding:n}},void 0,o));f(this,"deleteFile",(e,{signal:n}={})=>a(this,u).call(this,{type:i.DELETE_FILE,data:{path:e}},void 0,n));f(this,"rename",(e,n,{signal:o}={})=>a(this,u).call(this,{type:i.RENAME,data:{oldPath:e,newPath:n}},void 0,o));f(this,"createDir",(e,{signal:n}={})=>a(this,u).call(this,{type:i.CREATE_DIR,data:{path:e}},void 0,n));f(this,"listDir",(e,{signal:n}={})=>a(this,u).call(this,{type:i.LIST_DIR,data:{path:e}},void 0,n));f(this,"deleteDir",(e,{signal:n}={})=>a(this,u).call(this,{type:i.DELETE_DIR,data:{path:e}},void 0,n))}on(e,n){e==="log"?a(this,S).push(n):e==="progress"&&a(this,N).push(n)}off(e,n){e==="log"?T(this,S,a(this,S).filter(o=>o!==n)):e==="progress"&&T(this,N,a(this,N).filter(o=>o!==n))}}E=new WeakMap,D=new WeakMap,I=new WeakMap,S=new WeakMap,N=new WeakMap,F=new WeakMap,u=new WeakMap;var G;(function(t){t.MEMFS="MEMFS",t.NODEFS="NODEFS",t.NODERAWFS="NODERAWFS",t.IDBFS="IDBFS",t.WORKERFS="WORKERFS",t.PROXYFS="PROXYFS"})(G||(G={}));const ce=new Error("failed to get response body reader"),le=new Error("failed to complete download"),de="Content-Length",fe=t=>new Promise((e,n)=>{const o=new FileReader;o.onload=()=>{const{result:r}=o;r instanceof ArrayBuffer?e(new Uint8Array(r)):e(new Uint8Array)},o.onerror=r=>{var s,d;n(Error(`File could not be read! Code=${((d=(s=r==null?void 0:r.target)==null?void 0:s.error)==null?void 0:d.code)||-1}`))},o.readAsArrayBuffer(t)}),ue=async t=>{let e;if(typeof t=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(t)?e=atob(t.split(",")[1]).split("").map(n=>n.charCodeAt(0)):e=await(await fetch(t)).arrayBuffer();else if(t instanceof URL)e=await(await fetch(t)).arrayBuffer();else if(t instanceof File||t instanceof Blob)e=await fe(t);else return new Uint8Array;return new Uint8Array(e)},pe=async(t,e)=>{var r;const n=await fetch(t);let o;try{const s=parseInt(n.headers.get(de)||"-1"),d=(r=n.body)==null?void 0:r.getReader();if(!d)throw ce;const p=[];let c=0;for(;;){const{done:h,value:w}=await d.read(),y=w?w.length:0;if(h){if(s!=-1&&s!==c)throw le;e&&e({url:t,total:s,received:c,delta:y,done:h});break}p.push(w),c+=y,e&&e({url:t,total:s,received:c,delta:y,done:h})}const m=new Uint8Array(c);let A=0;for(const h of p)m.set(h,A),A+=h.length;o=m.buffer}catch(s){console.log("failed to send download progress event: ",s),o=await n.arrayBuffer()}return o},j=async(t,e,n=!1,o)=>{const r=n?await pe(t,o):await(await fetch(t)).arrayBuffer(),s=new Blob([r],{type:e});return URL.createObjectURL(s)},me=document.getElementById("transcodeStatus"),C=document.getElementById("transcodeText"),q=document.getElementById("transcodeBar");console.log("[DEBUG]",{crossOriginIsolated:window.crossOriginIsolated,sab:typeof SharedArrayBuffer,location:location.href});let k=null,O=null,b=!1;function Ee(){if(O&&O.readyState===WebSocket.OPEN)return;const e=`${location.protocol==="https:"?"wss":"ws"}://${location.host}/ws/stream`;O=new WebSocket(e);let n=null;O.onopen=()=>{n=setInterval(()=>{O.readyState===WebSocket.OPEN&&O.send(JSON.stringify({type:"keepalive"}))},1e4),console.log("[WS] stream connected")},O.onclose=()=>{clearInterval(n),console.warn("[WS] stream disconnected")},O.onerror=o=>{clearInterval(n),console.warn("[WS] stream error",o)},O.onmessage=o=>{let r;try{r=JSON.parse(o.data)}catch{console.warn("[WARN] failed to parse websocket message");return}console.log("receive info message"),r.type==="stream-status"&&(r.status==="error"&&l("âŒ æŽ¨æµå‡ºé”™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜","error"),r.status==="stopped"&&l("â¹ æŽ¨æµå·²ç»“æŸ","info"),r.status==="running"&&l("âœ… æŽ¨æµä¸­","ok"),r.status==="info"&&l(`${r.message}`,"info"))}}async function x(){if(k)return k;const t=await fetch("/api/internal/admin-token");if(!t.ok)throw new Error("æ— æ³•èŽ·å– admin token");return k=(await t.json()).token,k}const g=[],U=new Set,H=document.getElementById("playlist"),K=document.getElementById("emptyTip"),X=document.getElementById("status"),B=document.getElementById("mode"),v=document.getElementById("loopSelector"),$=document.getElementById("loopTarget"),he=document.getElementById("fileInput");function Z(t){return`${t.name}|${t.size}|${t.lastModified}`}function we(t){return(t/1024/1024).toFixed(1)+" MB"}function l(t,e=""){X.textContent=t,X.className="status "+e}function Q(){if(H.innerHTML="",$.innerHTML="",g.length===0){K.style.display="block",v.classList.add("hidden");return}K.style.display="none",g.forEach((t,e)=>{const n=t.originalFile,o=document.createElement("li");o.innerHTML=`
      <span>
        ${e+1}. ${n.name}
        <span class="small">(${we(n.size)})</span>
      </span>
      <button onclick="removeItem(${e})">ç§»é™¤</button>
    `,H.appendChild(o);const r=document.createElement("option");r.value=e,r.textContent=n.name,$.appendChild(r)}),B.value==="loop"&&v.classList.remove("hidden")}function ge(t){const n=g[t].originalFile;U.delete(Z(n)),g.splice(t,1),Q()}async function ye(t){const e=await t.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",e);return[...new Uint8Array(n)].map(o=>o.toString(16).padStart(2,"0")).join("")}async function z(t){const e=await x(),n=await fetch("/api/stream/check",{method:"POST",headers:{"Content-Type":"application/json","x-admin-token":e},body:JSON.stringify({fingerprint:t})});return n.ok?await n.json():null}function V(){const t=navigator.userAgent;if(/^((?!chrome|android).)*safari/i.test(t))return!1;let n=!1;try{n=typeof SharedArrayBuffer<"u"}catch{n=!1}return!Re()&&n&&"Worker"in window}function Re(){return/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)}async function Oe(){if(g.length===0){l("âŒ æ’­æ”¾åˆ—è¡¨ä¸ºç©º","error");return}const t=B.value,e=new FormData;l("â³ å‡†å¤‡æŽ¨æµâ€¦");const n=await x(),o=V();l(o?"ðŸ–¥ï¸ æ¡Œé¢çŽ¯å¢ƒï¼Œä½¿ç”¨å®¢æˆ·ç«¯è½¬ç â€¦":"ðŸ“± ç§»åŠ¨ç«¯æˆ–ä¸æ”¯æŒè½¬ç ï¼Œä½¿ç”¨æœåŠ¡å™¨è½¬ç â€¦");const r=[],s=[];if(t==="loop"){const c=Number($.value),m=g[c],A=m.originalFile,h=m.fingerprint,w=await z(h);if(w!=null&&w.exists)s.push({filePath:w.path,index:c});else{if(!o){l("âŒ å½“å‰çŽ¯å¢ƒä¸æ”¯æŒå®¢æˆ·ç«¯è½¬ç ","error");return}console.log("[INFO] å¼€å§‹è½¬ç ..."),_(0,"å‡†å¤‡è½¬ç ç¬¬ 1 / 1 ä¸ªè§†é¢‘");const y=await Y(A,0,1);r.push({file:y,fingerprint:h,index:c})}e.append("loopIndex",c)}else{const c=g.length;for(let m=0;m<g.length;m++){const A=g[m],h=A.originalFile,w=A.fingerprint,y=await z(w);if(y!=null&&y.exists){s.push({filePath:y.path,index:m});continue}if(!o){l("âŒ å½“å‰çŽ¯å¢ƒä¸æ”¯æŒå®¢æˆ·ç«¯è½¬ç ","error");return}_(0,`å‡†å¤‡è½¬ç ç¬¬ ${m+1} / ${c} ä¸ªè§†é¢‘ï¼š${h.name}`),console.log("[INFO] å¼€å§‹è½¬ç ...");const te=await Y(h,m,c);r.push({file:te,fingerprint:w,index:m})}}for(const c of s)e.append("existing",JSON.stringify(c));for(const c of r)e.append("files",c.file,c.file.name),e.append("fingerprints",c.fingerprint);r.length>0&&e.append("clientTranscoded","1"),e.append("mode",t),l("ðŸ“¡ æ­£åœ¨å¯åŠ¨æŽ¨æµâ€¦");const d=await fetch("/api/stream/start",{method:"POST",headers:{"x-admin-token":n},body:e}),p=await d.text();d.ok?l("âœ… æŽ¨æµä¸­","ok"):l("âŒ "+p,"error")}async function Ie(){const t=await x(),n=await(await fetch("/api/stream/stop",{method:"POST",headers:{"x-admin-token":t}})).text();l(n)}const Le=1280,De=720,P=30,Ae=2*60*60,Se="/stream/ffmpeg";function Ne(){return Se}let R,J=!1;async function Te(){if(!(R||J)){if(!V()){console.log("[ffmpeg] client transcode not supported, skip preload");return}J=!0,l("â³ åˆå§‹åŒ–è½¬ç å¼•æ“Žâ€¦");try{await ee(),l("âœ… è½¬ç å¼•æ“Žå°±ç»ª")}catch(t){console.warn("[ffmpeg] preload failed",t),l("âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå®¢æˆ·ç«¯è½¬ç ")}}}async function ee(){if(R)return R;R=new ie;const t=Ne();return await R.load({coreURL:await j(`${t}/ffmpeg-core.js`,"text/javascript"),wasmURL:await j(`${t}/ffmpeg-core.wasm`,"application/wasm")}),R.on("progress",({progress:e,time:n})=>{if(!b)return;const o=Math.min(99,Math.round(e*100));_(o)}),R}async function Y(t,e,n){if(t.duration&&t.duration>Ae)throw new Error("è§†é¢‘æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é‡æ–°ä¸Šä¼ ä¸è¶…è¿‡2Gçš„æ–‡ä»¶ã€‚");b=!0,console.log("[INFO] loading ffmpeg");const o=await ee();console.log("[INFO] load ffmpeg success");const r=`input-${Date.now()}.mp4`,s=`output-${Date.now()}.mp4`;_(0,`å‡†å¤‡è½¬ç ç¬¬ ${e+1}/${n} ä¸ªè§†é¢‘`),await o.writeFile(r,await ue(t));try{console.log("[INFO] start transcoding..."),await o.exec(["-i",r,"-vf",`scale=${Le}:${De}:force_original_aspect_ratio=decrease,fps=${P}`,"-c:v","libx264","-pix_fmt","yuv420p","-preset","veryfast","-crf","24","-g",String(P*2),"-keyint_min",String(P),"-sc_threshold","0","-c:a","aac","-ar","44100","-ac","2","-b:a","128k","-movflags","+faststart",s])}catch(p){throw p.name==="AbortError"?(console.warn("[transcode] cancelled by user"),new Error("CLIENT_TRANSCODE_CANCELLED")):(console.error("[transcode] ffmpeg failed",p),new Error("CLIENT_TRANSCODE_FAILED"))}finally{b=!1}const d=await o.readFile(s);try{await o.unlink(r),await o.unlink(s)}catch(p){console.warn(`[WARN] unlink file failed, error: ${p}`)}return console.log("[INFO] finish transcode"),_(100,"âœ… è½¬ç å®Œæˆ"),new File([d.buffer],t.name.replace(/\.\w+$/,".mp4"),{type:"video/mp4"})}async function be(){!R||!b||(console.warn("[ffmpeg] terminate worker"),await R.terminate(),R=null,b=!1,C.textContent="è½¬ç å·²å–æ¶ˆ",q.style.width="0%",l("â›” å·²å–æ¶ˆè½¬ç ","info"))}function _(t,e){me.style.display="block",q.style.width=`${t}%`,e?C.textContent=e:C.textContent=`è½¬ç ä¸­â€¦ ${t}%`}function _e(){he.addEventListener("change",async t=>{Te();const e=Array.from(t.target.files);if(!e.length)return;let n=!1;for(const o of e){const r=Z(o);if(U.has(r))continue;const s=await ye(o);g.push({originalFile:o,fingerprint:s}),U.add(r),n=!0}t.target.value="",n&&Q()}),B.addEventListener("change",()=>{B.value==="loop"&&g.length>0?v.classList.remove("hidden"):v.classList.add("hidden")})}document.addEventListener("DOMContentLoaded",()=>{Ee(),_e()});window.start=Oe;window.stop=Ie;window.cancelTranscode=be;window.removeItem=ge;
