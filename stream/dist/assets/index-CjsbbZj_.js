var gt=Object.defineProperty;var tt=t=>{throw TypeError(t)};var Ot=(t,e,n)=>e in t?gt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var R=(t,e,n)=>Ot(t,typeof e!="symbol"?e+"":e,n),et=(t,e,n)=>e.has(t)||tt("Cannot "+n);var s=(t,e,n)=>(et(t,e,"read from private field"),n?n.call(t):e.get(t)),T=(t,e,n)=>e.has(t)?tt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),v=(t,e,n,a)=>(et(t,e,"write to private field"),a?a.call(t,n):e.set(t,n),n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();var c;(function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.FFPROBE="FFPROBE",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG",t.MOUNT="MOUNT",t.UNMOUNT="UNMOUNT"})(c||(c={}));const wt=(()=>{let t=0;return()=>t++})(),yt=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),Nt=new Error("called FFmpeg.terminate()");var y,b,A,k,_,G,S;class Dt{constructor(){T(this,y,null);T(this,b,{});T(this,A,{});T(this,k,[]);T(this,_,[]);R(this,"loaded",!1);T(this,G,()=>{s(this,y)&&(s(this,y).onmessage=({data:{id:e,type:n,data:a}})=>{switch(n){case c.LOAD:this.loaded=!0,s(this,b)[e](a);break;case c.MOUNT:case c.UNMOUNT:case c.EXEC:case c.FFPROBE:case c.WRITE_FILE:case c.READ_FILE:case c.DELETE_FILE:case c.RENAME:case c.CREATE_DIR:case c.LIST_DIR:case c.DELETE_DIR:s(this,b)[e](a);break;case c.LOG:s(this,k).forEach(r=>r(a));break;case c.PROGRESS:s(this,_).forEach(r=>r(a));break;case c.ERROR:s(this,A)[e](a);break}delete s(this,b)[e],delete s(this,A)[e]})});T(this,S,({type:e,data:n},a=[],r)=>s(this,y)?new Promise((o,i)=>{const f=wt();s(this,y)&&s(this,y).postMessage({id:f,type:e,data:n},a),s(this,b)[f]=o,s(this,A)[f]=i,r==null||r.addEventListener("abort",()=>{i(new DOMException(`Message # ${f} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(yt));R(this,"load",({classWorkerURL:e,...n}={},{signal:a}={})=>(s(this,y)||(v(this,y,e?new Worker(new URL(e,import.meta.url),{type:"module"}):new Worker(new URL("/stream/assets/worker-DYSz7Krg.js",import.meta.url),{type:"module"})),s(this,G).call(this)),s(this,S).call(this,{type:c.LOAD,data:n},void 0,a)));R(this,"exec",(e,n=-1,{signal:a}={})=>s(this,S).call(this,{type:c.EXEC,data:{args:e,timeout:n}},void 0,a));R(this,"ffprobe",(e,n=-1,{signal:a}={})=>s(this,S).call(this,{type:c.FFPROBE,data:{args:e,timeout:n}},void 0,a));R(this,"terminate",()=>{const e=Object.keys(s(this,A));for(const n of e)s(this,A)[n](Nt),delete s(this,A)[n],delete s(this,b)[n];s(this,y)&&(s(this,y).terminate(),v(this,y,null),this.loaded=!1)});R(this,"writeFile",(e,n,{signal:a}={})=>{const r=[];return n instanceof Uint8Array&&r.push(n.buffer),s(this,S).call(this,{type:c.WRITE_FILE,data:{path:e,data:n}},r,a)});R(this,"mount",(e,n,a)=>{const r=[];return s(this,S).call(this,{type:c.MOUNT,data:{fsType:e,options:n,mountPoint:a}},r)});R(this,"unmount",e=>{const n=[];return s(this,S).call(this,{type:c.UNMOUNT,data:{mountPoint:e}},n)});R(this,"readFile",(e,n="binary",{signal:a}={})=>s(this,S).call(this,{type:c.READ_FILE,data:{path:e,encoding:n}},void 0,a));R(this,"deleteFile",(e,{signal:n}={})=>s(this,S).call(this,{type:c.DELETE_FILE,data:{path:e}},void 0,n));R(this,"rename",(e,n,{signal:a}={})=>s(this,S).call(this,{type:c.RENAME,data:{oldPath:e,newPath:n}},void 0,a));R(this,"createDir",(e,{signal:n}={})=>s(this,S).call(this,{type:c.CREATE_DIR,data:{path:e}},void 0,n));R(this,"listDir",(e,{signal:n}={})=>s(this,S).call(this,{type:c.LIST_DIR,data:{path:e}},void 0,n));R(this,"deleteDir",(e,{signal:n}={})=>s(this,S).call(this,{type:c.DELETE_DIR,data:{path:e}},void 0,n))}on(e,n){e==="log"?s(this,k).push(n):e==="progress"&&s(this,_).push(n)}off(e,n){e==="log"?v(this,k,s(this,k).filter(a=>a!==n)):e==="progress"&&v(this,_,s(this,_).filter(a=>a!==n))}}y=new WeakMap,b=new WeakMap,A=new WeakMap,k=new WeakMap,_=new WeakMap,G=new WeakMap,S=new WeakMap;var nt;(function(t){t.MEMFS="MEMFS",t.NODEFS="NODEFS",t.NODERAWFS="NODERAWFS",t.IDBFS="IDBFS",t.WORKERFS="WORKERFS",t.PROXYFS="PROXYFS"})(nt||(nt={}));const It=new Error("failed to get response body reader"),Lt=new Error("failed to complete download"),At="Content-Length",Tt=t=>new Promise((e,n)=>{const a=new FileReader;a.onload=()=>{const{result:r}=a;r instanceof ArrayBuffer?e(new Uint8Array(r)):e(new Uint8Array)},a.onerror=r=>{var o,i;n(Error(`File could not be read! Code=${((i=(o=r==null?void 0:r.target)==null?void 0:o.error)==null?void 0:i.code)||-1}`))},a.readAsArrayBuffer(t)}),bt=async t=>{let e;if(typeof t=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(t)?e=atob(t.split(",")[1]).split("").map(n=>n.charCodeAt(0)):e=await(await fetch(t)).arrayBuffer();else if(t instanceof URL)e=await(await fetch(t)).arrayBuffer();else if(t instanceof File||t instanceof Blob)e=await Tt(t);else return new Uint8Array;return new Uint8Array(e)},Pt=async(t,e)=>{var r;const n=await fetch(t);let a;try{const o=parseInt(n.headers.get(At)||"-1"),i=(r=n.body)==null?void 0:r.getReader();if(!i)throw It;const f=[];let I=0;for(;;){const{done:u,value:L}=await i.read(),N=L?L.length:0;if(u){if(o!=-1&&o!==I)throw Lt;e&&e({url:t,total:o,received:I,delta:N,done:u});break}f.push(L),I+=N,e&&e({url:t,total:o,received:I,delta:N,done:u})}const l=new Uint8Array(I);let m=0;for(const u of f)l.set(u,m),m+=u.length;a=l.buffer}catch(o){console.log("failed to send download progress event: ",o),a=await n.arrayBuffer()}return a},at=async(t,e,n=!1,a)=>{const r=n?await Pt(t,a):await(await fetch(t)).arrayBuffer(),o=new Blob([r],{type:e});return URL.createObjectURL(o)},dt=document.getElementById("transcodeStatus"),Y=document.getElementById("transcodeText"),ut=document.getElementById("transcodeBar"),d={NONE:"none",TRANSCODING:"doing",DONE:"done",ERROR:"error",SKIPPED:"skipped"},w={NONE:"none",UPLOADING:"uploading",DONE:"done",ERROR:"error"},h={IDLE:"idle",TRANSCODING:"transcoding",RUNNING:"running",ERROR:"error"};console.log("[DEBUG]",{crossOriginIsolated:window.crossOriginIsolated,sab:typeof SharedArrayBuffer,location:location.href});const j=document.getElementById("autoUploadAfterTranscode");function kt(){return j==null?void 0:j.checked}let $=null,O=null,U=null,J=0,q=!1;const _t=1e3,Ct=3e4;let B=!1,x=h.IDLE;Object.defineProperty(window,"currentStreamStatus",{get(){return x},set(t){if(x===t)return;const e=x;x=t,console.log("[StreamStatus]",e,"â†’",t),pt()}});function Ut(){if(U)return;J++;const t=Math.min(_t*Math.pow(2,J-1),Ct);console.log(`[WS] reconnect in ${t}ms`),U=setTimeout(()=>{U=null,ft()},t)}function ft(){if(O&&(O.readyState===WebSocket.OPEN||O.readyState===WebSocket.CONNECTING))return;q=!1;const e=`${location.protocol==="https:"?"wss":"ws"}://${location.host}/ws/stream`;O=new WebSocket(e);let n=null;O.onopen=()=>{n=setInterval(()=>{O.readyState===WebSocket.OPEN&&O.send(JSON.stringify({type:"keepalive"}))},25e3),J=0,console.log("[WS] stream connected")},O.onclose=()=>{if(clearInterval(n),console.warn("[WS] stream disconnected"),O=null,q){console.log("[WS] closed manually, no reconnect");return}Ut()},O.onerror=a=>{clearInterval(n),console.warn("[WS] stream error",a)},O.onmessage=a=>{let r;try{r=JSON.parse(a.data)}catch{console.warn("[WARN] failed to parse websocket message");return}console.log("receive websocket message"),r.type==="stream-status"&&(r.status==="error"&&(Q(),currentStreamStatus=h.ERROR,E("âŒ æ¨æµå‡ºé”™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜","error")),r.status==="stopped"&&(Q(),currentStreamStatus=h.IDLE,E("â¹ æ¨æµå·²ç»“æŸ","info")),r.status==="running"&&E("âœ… æ¨æµä¸­","ok"),r.status==="info"&&E(`${r.message}`,"info"))}}async function K(){if($)return $;const t=await fetch("/api/internal/admin-token");if(!t.ok)throw new Error("æ— æ³•è·å– admin token");return $=(await t.json()).token,$}const p=[],V=new Set,rt=document.getElementById("playlist"),ot=document.getElementById("emptyTip"),st=document.getElementById("status"),W=document.getElementById("mode"),M=document.getElementById("loopSelector"),Z=document.getElementById("loopTarget"),vt=document.getElementById("fileInput"),z=document.getElementById("startBtn");function Et(t){return`${t.name}|${t.size}|${t.lastModified}`}function Bt(t){return(t/1024/1024).toFixed(1)+" MB"}function E(t,e=""){st.textContent=t,st.className="status "+e}function g(){if(rt.innerHTML="",Z.innerHTML="",p.length===0){ot.style.display="block",M.classList.add("hidden");return}ot.style.display="none",p.forEach((t,e)=>{const n=t.originalFile;let a="",r="";t.transcodeStatus===d.DONE||t.transcodeStatus===d.SKIPPED?(a="âœ… å·²è½¬ç ",r="ok"):t.transcodeStatus===d.TRANSCODING?(a="â³ æ­£åœ¨è½¬ç ",r="info"):t.transcodeStatus===d.ERROR&&(a="âŒ è½¬ç å¤±è´¥",r="error");let o="",i="";t.cacheStatus===w.DONE?(o="ğŸ“¦ å·²ç¼“å­˜",i="ok"):t.cacheStatus===w.UPLOADING?(o="ğŸ“¦ ä¸Šä¼ ä¸­",i="info"):t.cacheStatus===w.ERROR&&(o="ğŸ“¦ ä¸Šä¼ å¤±è´¥",i="error");let f=`
            <div class="actions">
                <button onclick="removeItem(${e})">ç§»é™¤</button>
            </div>
        `;t.transcodeStatus===d.ERROR&&(f=`
                <div class="actions">
                <button onclick="retryTranscode(${e})">ğŸ” é‡è¯•</button>
                <button onclick="removeItem(${e})">ç§»é™¤</button>
                </div>
            `),t.cacheStatus===w.ERROR&&(f=`
                <div class="actions">
                <button onclick="retryCacheUpload(${e})">ğŸ“¦ é‡è¯•ä¸Šä¼ </button>
                <button onclick="removeItem(${e})">ç§»é™¤</button>
                </div>
            `);const I=document.createElement("li");I.innerHTML=`
            <span>
                ${e+1}. ${n.name}
                <span class="small">(${Bt(n.size)})</span>
                ${a?`<span class="small ${r}" style="margin-left:8px;">${a}</span>`:""}
                ${o?`<span class="small ${i}" style="margin-left:6px;">${o}</span>`:""}
            </span>
            ${f}
            `,rt.appendChild(I);const l=document.createElement("option");l.value=e,l.textContent=n.name,Z.appendChild(l)}),W.value==="loop"&&M.classList.remove("hidden")}function pt(){const t=currentStreamStatus===h.TRANSCODING||currentStreamStatus===h.RUNNING;z.disabled=t,z.classList.toggle("opacity-50",t),z.classList.toggle("cursor-not-allowed",t)}async function Ft(t){const e=p[t];e&&(e.transcodeStatus=d.NONE,g(),E(`è¯·ç‚¹å‡»å¼€å§‹æ¨æµæ¥é‡æ–°è½¬ç ï¼š${e.originalFile.name}`))}async function $t(t){const e=p[t];if(!(!e||e.transcodeStatus!==d.DONE))try{e.cacheStatus=w.UPLOADING,g(),await ht(e,e.transcodedFile,e.fingerprint),e.cacheStatus=w.DONE}catch{console.warn(`[WARN] failed to upload transcoded video: ${e.originalFile.name}`),e.cacheStatus=w.ERROR}finally{g()}}function xt(){return p.some(t=>t.transcodeStatus===d.ERROR)}function Wt(){return p.some(t=>t.transcodeStatus===d.DONE||t.transcodeStatus===d.SKIPPED)}function Mt(t){const n=p[t].originalFile;V.delete(Et(n)),p.splice(t,1),g()}async function Gt(t){const e=await t.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",e);return[...new Uint8Array(n)].map(a=>a.toString(16).padStart(2,"0")).join("")}async function it(t){const e=await K(),n=await fetch("/api/stream/check",{method:"POST",headers:{"Content-Type":"application/json","x-admin-token":e},body:JSON.stringify({fingerprint:t})});return n.ok?await n.json():null}function H(){dt.style.display="none"}function mt(){const t=navigator.userAgent;if(/^((?!chrome|android).)*safari/i.test(t))return!1;let n=!1;try{n=typeof SharedArrayBuffer<"u"}catch{n=!1}return!Kt()&&n&&"Worker"in window}function Kt(){return/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)}function jt(t){if(p.length===1)return!1;const e=p.some(n=>n.transcodeStatus===d.ERROR);return!(t===p.length-1&&!e)}function Q(){for(const t of p)(t.transcodeStatus===d.SKIPPED||t.transcodeStatus===d.DONE)&&(t.transcodeStatus=d.NONE)}async function zt(){if(console.log(`Stream status: ${currentStreamStatus}`),currentStreamStatus!==h.IDLE&&currentStreamStatus!==h.ERROR)return;if(p.length===0){E("âŒ æ’­æ”¾åˆ—è¡¨ä¸ºç©º","error");return}Q(),currentStreamStatus=h.TRANSCODING;const t=W.value,e=new FormData,n=await K(),a=mt();E(a?"ğŸ–¥ï¸ æ¡Œé¢ç¯å¢ƒï¼Œä½¿ç”¨å®¢æˆ·ç«¯è½¬ç â€¦":"ğŸ“± ç§»åŠ¨ç«¯æˆ–ä¸æ”¯æŒè½¬ç ï¼Œä½¿ç”¨æœåŠ¡å™¨è½¬ç â€¦");const r=[],o=[];if(t==="loop"){const l=Number(Z.value),m=p[l],u=m.originalFile,L=m.fingerprint,N=await it(L);if(N!=null&&N.exists)o.push({filePath:N.path,index:l}),m.transcodeStatus=d.DONE,g();else{if(!a){E("âŒ å½“å‰ç¯å¢ƒä¸æ”¯æŒå®¢æˆ·ç«¯è½¬ç ","error"),currentStreamStatus=h.ERROR;return}console.log("[INFO] å¼€å§‹è½¬ç ..."),F(0,"å‡†å¤‡è½¬ç ç¬¬ 1 / 1 ä¸ªè§†é¢‘"),m.transcodeStatus=d.TRANSCODING,g();const C=await lt(u,0,1);r.push({file:C,fingerprint:L,index:l}),m.transcodeStatus=d.DONE,g()}e.append("loopIndex",l)}else{const l=p.length;for(let m=0;m<p.length;m++){const u=p[m];if(u.transcodeStatus===d.DONE||u.transcodeStatus===d.SKIPPED){u.transcodeStatus=d.SKIPPED;continue}if(u.transcodeStatus===d.ERROR)continue;const L=u.originalFile,N=u.fingerprint,C=await it(N);if(C!=null&&C.exists){o.push({filePath:C.path,index:m}),u.transcodeStatus=d.NONE,u.cacheStatus=w.DONE,g();continue}if(!a){E("âŒ å½“å‰ç¯å¢ƒä¸æ”¯æŒå®¢æˆ·ç«¯è½¬ç ","error"),currentStreamStatus=h.ERROR;return}F(0,`å‡†å¤‡è½¬ç ç¬¬ ${m+1} / ${l} ä¸ªè§†é¢‘ï¼š${L.name}`),u.transcodeStatus=d.TRANSCODING,g(),console.log("[INFO] å¼€å§‹è½¬ç ...");try{const P=await lt(L,m,l);if(r.push({file:P,fingerprint:N,index:m}),u.transcodedFile=P,u.transcodeStatus=d.DONE,g(),kt()&&jt(m))try{u.cacheStatus=w.UPLOADING,g(),await ht(u,P,N)}catch(St){console.warn("[cache] upload failed",St)}finally{g()}}catch(P){if(String(P==null?void 0:P.message).includes("called FFmpeg.terminate()")){u.transcodeStatus=d.NONE,E("è½¬ç å–æ¶ˆ"),g(),H(),currentStreamStatus=h.IDLE;return}else u.transcodeStatus=d.ERROR;m==l-1&&H(),g();continue}}}if(o.length==0&&r.length==0){E("æ–‡ä»¶è½¬ç å¤±è´¥","error"),currentStreamStatus=h.ERROR;return}for(const l of r)l.cacheStatus==w.DONE&&l.cachedPath.length>0?o.push({filePath:l.cachedPath,index:l.index}):(e.append("files",l.file,l.file.name),e.append("fingerprints",l.fingerprint),e.append("indexs",l.index));r.length>0&&e.append("clientTranscoded","1");for(const l of o)e.append("existing",JSON.stringify(l));if(e.append("mode",t),H(),xt()){if(!Wt()){alert("âŒ æ‰€æœ‰è§†é¢‘å‡è½¬ç å¤±è´¥ï¼Œæ— æ³•å¼€å§‹æ¨æµ"),E("âŒ è½¬ç å¤±è´¥ï¼Œè¯·å¤„ç†åé‡è¯•","error"),currentStreamStatus=h.ERROR;return}if(E("âš ï¸ è½¬ç å®Œæˆï¼Œå­˜åœ¨å¤±è´¥è§†é¢‘ï¼Œç­‰å¾…ç¡®è®¤â€¦"),!window.confirm(`âš ï¸ æœ‰è§†é¢‘è½¬ç å¤±è´¥ã€‚

ç‚¹å‡»ã€Œç¡®å®šã€å°†å¿½ç•¥å¤±è´¥çš„è§†é¢‘ï¼Œä»…æ¨æµå·²è½¬ç æˆåŠŸçš„å†…å®¹ã€‚
ç‚¹å‡»ã€Œå–æ¶ˆã€è¿”å›å¤„ç†å¤±è´¥è§†é¢‘ï¼ˆé‡è¯•æˆ–ç§»é™¤ï¼‰ã€‚`)){E("â¸ å·²å–æ¶ˆæ¨æµï¼Œè¯·å¤„ç†å¤±è´¥çš„è§†é¢‘"),currentStreamStatus=h.IDLE;return}}E("ğŸ“¡ æ­£åœ¨å¯åŠ¨æ¨æµâ€¦"),currentStreamStatus=h.RUNNING;const i=location.hostname.endsWith("ledbygrace.live")?"https://upload.ledbygrace.live":"",f=await fetch(`${i}/api/stream/start`,{method:"POST",headers:{"x-admin-token":n},body:e}),I=await f.text();f.ok?E("âœ… æ¨æµä¸­","ok"):E("âŒ "+I,"error"),f.ok==!1&&(currentStreamStatus=h.ERROR)}async function Ht(){if(currentStreamStatus!==h.RUNNING)return;const t=await K();(await fetch("/api/stream/stop",{method:"POST",headers:{"x-admin-token":t}})).ok||E("è¯·æ±‚åœæ­¢æ¨æµå¤±è´¥")}async function ht(t,e,n){if(t.cacheStatus===w.DONE)return;const a=await K(),r=new FormData;r.append("file",e,e.name),r.append("fingerprint",n);const o=location.hostname.endsWith("ledbygrace.live")?"https://upload.ledbygrace.live":"",i=await fetch(`${o}/api/stream/cache`,{method:"PUT",headers:{"x-admin-token":a},body:r});if(!i.ok)throw t.cacheStatus=w.ERROR,new Error("UPLOAD_CACHE_FAILED");t.cacheStatus=w.DONE,t.cachedPath=i.path}const Xt=2*60*60,Yt="/stream/ffmpeg";function Jt(){return Yt}let D,ct=!1;async function qt(){if(!(D||ct)){if(!mt()){console.log("[ffmpeg] client transcode not supported, skip preload");return}ct=!0,E("â³ åˆå§‹åŒ–è½¬ç å¼•æ“â€¦");try{await Rt(),E("âœ… è½¬ç å¼•æ“å°±ç»ª")}catch(t){console.warn("[ffmpeg] preload failed",t),E("âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå®¢æˆ·ç«¯è½¬ç ")}}}async function Rt(){if(D)return D;D=new Dt;const t=Jt();return await D.load({coreURL:await at(`${t}/ffmpeg-core.js`,"text/javascript"),wasmURL:await at(`${t}/ffmpeg-core.wasm`,"application/wasm")}),D.on("progress",({progress:e,time:n})=>{if(!B)return;const a=Math.min(99,Math.round(e*100));F(a)}),D.on("error",e=>console.error("[ERROR]",e.message)),D}const X=24;async function lt(t,e,n){if(t.duration&&t.duration>Xt)throw new Error("è§†é¢‘æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é‡æ–°ä¸Šä¼ ä¸è¶…è¿‡2Gçš„æ–‡ä»¶ã€‚");B=!0,console.log("[INFO] loading ffmpeg");const a=await Rt();console.log("[INFO] load ffmpeg success");const r=`input-${Date.now()}.mp4`,o=`output-${Date.now()}.mp4`;F(0,`å‡†å¤‡è½¬ç ç¬¬ ${e+1}/${n} ä¸ªè§†é¢‘`),await a.writeFile(r,await bt(t));try{console.log("[INFO] start transcoding..."),await a.exec(["-i",r,"-vf","scale='min(1280,iw)':'min(720,ih)':force_original_aspect_ratio=decrease,format=yuv420p","-r",`${X}`,"-c:v","libx264","-pix_fmt","yuv420p","-preset","superfast","-tune","zerolatency","-x264-params","ref=2:bframes=0:rc-lookahead=0","-b:v","900k","-maxrate","900k","-bufsize","1800k","-g",String(X*2),"-keyint_min",String(X*2),"-sc_threshold","0","-c:a","aac","-ar","48000","-ac","2","-b:a","64k",o])}catch(f){throw console.error("[transcode] ffmpeg failed",f),f}finally{B=!1}let i;try{i=await a.readFile(o)}catch(f){throw console.log(`[ERROR] failed to read transcoded data, error:${f}`),f}if(!i||i.length===0)throw console.error("[transcode] empty output file",{file:t.name,size:t.size}),new Error("CLIENT_TRANSCODE_EMPTY_OUTPUT");try{await a.deleteFile(r),await a.deleteFile(o)}catch(f){console.warn(`[WARN] unlink file failed, error: ${f}`)}return console.log("[INFO] finish transcode"),F(100,"âœ… è½¬ç å®Œæˆ"),new File([i.buffer],t.name.replace(/\.\w+$/,".mp4"),{type:"video/mp4"})}async function Vt(){!D||!B||(console.warn("[ffmpeg] terminate worker"),await D.terminate(),D=null,B=!1,Y.textContent="è½¬ç å·²å–æ¶ˆ",ut.style.width="0%",E("â›” å·²å–æ¶ˆè½¬ç ","info"))}function F(t,e){dt.style.display="block",ut.style.width=`${t}%`,e?Y.textContent=e:Y.textContent=`è½¬ç ä¸­â€¦ ${t}%`}function Zt(){vt.addEventListener("change",async t=>{qt();const e=Array.from(t.target.files);if(!e.length)return;let n=!1;for(let a=0;a<e.length;a++){const r=e[a],o=Et(r);if(V.has(o))continue;const i=await Gt(r);p.push({index:a,originalFile:r,fingerprint:i,transcodeStatus:d.NONE,cacheStatus:w.NONE,cachedPath:""}),V.add(o),n=!0}t.target.value="",n&&g()}),W.addEventListener("change",()=>{W.value==="loop"&&p.length>0?M.classList.remove("hidden"):M.classList.add("hidden")})}document.addEventListener("DOMContentLoaded",()=>{ft(),Zt(),pt()});window.addEventListener("beforeunload",()=>{q=!0,O&&(O.close(),O=null),U&&(clearTimeout(U),U=null)});window.start=zt;window.stop=Ht;window.cancelTranscode=Vt;window.removeItem=Mt;window.retryTranscode=Ft;window.retryCacheUpload=$t;
