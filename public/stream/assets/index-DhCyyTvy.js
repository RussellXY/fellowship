var mt=Object.defineProperty;var V=t=>{throw TypeError(t)};var ht=(t,e,n)=>e in t?mt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var h=(t,e,n)=>ht(t,typeof e!="symbol"?e+"":e,n),Z=(t,e,n)=>e.has(t)||V("Cannot "+n);var s=(t,e,n)=>(Z(t,e,"read from private field"),n?n.call(t):e.get(t)),T=(t,e,n)=>e.has(t)?V("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),v=(t,e,n,a)=>(Z(t,e,"write to private field"),a?a.call(t,n):e.set(t,n),n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();var c;(function(t){t.LOAD="LOAD",t.EXEC="EXEC",t.FFPROBE="FFPROBE",t.WRITE_FILE="WRITE_FILE",t.READ_FILE="READ_FILE",t.DELETE_FILE="DELETE_FILE",t.RENAME="RENAME",t.CREATE_DIR="CREATE_DIR",t.LIST_DIR="LIST_DIR",t.DELETE_DIR="DELETE_DIR",t.ERROR="ERROR",t.DOWNLOAD="DOWNLOAD",t.PROGRESS="PROGRESS",t.LOG="LOG",t.MOUNT="MOUNT",t.UNMOUNT="UNMOUNT"})(c||(c={}));const Rt=(()=>{let t=0;return()=>t++})(),St=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),gt=new Error("called FFmpeg.terminate()");var w,b,A,k,U,M,R;class Ot{constructor(){T(this,w,null);T(this,b,{});T(this,A,{});T(this,k,[]);T(this,U,[]);h(this,"loaded",!1);T(this,M,()=>{s(this,w)&&(s(this,w).onmessage=({data:{id:e,type:n,data:a}})=>{switch(n){case c.LOAD:this.loaded=!0,s(this,b)[e](a);break;case c.MOUNT:case c.UNMOUNT:case c.EXEC:case c.FFPROBE:case c.WRITE_FILE:case c.READ_FILE:case c.DELETE_FILE:case c.RENAME:case c.CREATE_DIR:case c.LIST_DIR:case c.DELETE_DIR:s(this,b)[e](a);break;case c.LOG:s(this,k).forEach(r=>r(a));break;case c.PROGRESS:s(this,U).forEach(r=>r(a));break;case c.ERROR:s(this,A)[e](a);break}delete s(this,b)[e],delete s(this,A)[e]})});T(this,R,({type:e,data:n},a=[],r)=>s(this,w)?new Promise((o,i)=>{const E=Rt();s(this,w)&&s(this,w).postMessage({id:E,type:e,data:n},a),s(this,b)[E]=o,s(this,A)[E]=i,r==null||r.addEventListener("abort",()=>{i(new DOMException(`Message # ${E} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(St));h(this,"load",({classWorkerURL:e,...n}={},{signal:a}={})=>(s(this,w)||(v(this,w,e?new Worker(new URL(e,import.meta.url),{type:"module"}):new Worker(new URL("/stream/assets/worker-DYSz7Krg.js",import.meta.url),{type:"module"})),s(this,M).call(this)),s(this,R).call(this,{type:c.LOAD,data:n},void 0,a)));h(this,"exec",(e,n=-1,{signal:a}={})=>s(this,R).call(this,{type:c.EXEC,data:{args:e,timeout:n}},void 0,a));h(this,"ffprobe",(e,n=-1,{signal:a}={})=>s(this,R).call(this,{type:c.FFPROBE,data:{args:e,timeout:n}},void 0,a));h(this,"terminate",()=>{const e=Object.keys(s(this,A));for(const n of e)s(this,A)[n](gt),delete s(this,A)[n],delete s(this,b)[n];s(this,w)&&(s(this,w).terminate(),v(this,w,null),this.loaded=!1)});h(this,"writeFile",(e,n,{signal:a}={})=>{const r=[];return n instanceof Uint8Array&&r.push(n.buffer),s(this,R).call(this,{type:c.WRITE_FILE,data:{path:e,data:n}},r,a)});h(this,"mount",(e,n,a)=>{const r=[];return s(this,R).call(this,{type:c.MOUNT,data:{fsType:e,options:n,mountPoint:a}},r)});h(this,"unmount",e=>{const n=[];return s(this,R).call(this,{type:c.UNMOUNT,data:{mountPoint:e}},n)});h(this,"readFile",(e,n="binary",{signal:a}={})=>s(this,R).call(this,{type:c.READ_FILE,data:{path:e,encoding:n}},void 0,a));h(this,"deleteFile",(e,{signal:n}={})=>s(this,R).call(this,{type:c.DELETE_FILE,data:{path:e}},void 0,n));h(this,"rename",(e,n,{signal:a}={})=>s(this,R).call(this,{type:c.RENAME,data:{oldPath:e,newPath:n}},void 0,a));h(this,"createDir",(e,{signal:n}={})=>s(this,R).call(this,{type:c.CREATE_DIR,data:{path:e}},void 0,n));h(this,"listDir",(e,{signal:n}={})=>s(this,R).call(this,{type:c.LIST_DIR,data:{path:e}},void 0,n));h(this,"deleteDir",(e,{signal:n}={})=>s(this,R).call(this,{type:c.DELETE_DIR,data:{path:e}},void 0,n))}on(e,n){e==="log"?s(this,k).push(n):e==="progress"&&s(this,U).push(n)}off(e,n){e==="log"?v(this,k,s(this,k).filter(a=>a!==n)):e==="progress"&&v(this,U,s(this,U).filter(a=>a!==n))}}w=new WeakMap,b=new WeakMap,A=new WeakMap,k=new WeakMap,U=new WeakMap,M=new WeakMap,R=new WeakMap;var Q;(function(t){t.MEMFS="MEMFS",t.NODEFS="NODEFS",t.NODERAWFS="NODERAWFS",t.IDBFS="IDBFS",t.WORKERFS="WORKERFS",t.PROXYFS="PROXYFS"})(Q||(Q={}));const wt=new Error("failed to get response body reader"),yt=new Error("failed to complete download"),Nt="Content-Length",Dt=t=>new Promise((e,n)=>{const a=new FileReader;a.onload=()=>{const{result:r}=a;r instanceof ArrayBuffer?e(new Uint8Array(r)):e(new Uint8Array)},a.onerror=r=>{var o,i;n(Error(`File could not be read! Code=${((i=(o=r==null?void 0:r.target)==null?void 0:o.error)==null?void 0:i.code)||-1}`))},a.readAsArrayBuffer(t)}),It=async t=>{let e;if(typeof t=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(t)?e=atob(t.split(",")[1]).split("").map(n=>n.charCodeAt(0)):e=await(await fetch(t)).arrayBuffer();else if(t instanceof URL)e=await(await fetch(t)).arrayBuffer();else if(t instanceof File||t instanceof Blob)e=await Dt(t);else return new Uint8Array;return new Uint8Array(e)},Lt=async(t,e)=>{var r;const n=await fetch(t);let a;try{const o=parseInt(n.headers.get(Nt)||"-1"),i=(r=n.body)==null?void 0:r.getReader();if(!i)throw wt;const E=[];let D=0;for(;;){const{done:u,value:I}=await i.read(),y=I?I.length:0;if(u){if(o!=-1&&o!==D)throw yt;e&&e({url:t,total:o,received:D,delta:y,done:u});break}E.push(I),D+=y,e&&e({url:t,total:o,received:D,delta:y,done:u})}const l=new Uint8Array(D);let m=0;for(const u of E)l.set(u,m),m+=u.length;a=l.buffer}catch(o){console.log("failed to send download progress event: ",o),a=await n.arrayBuffer()}return a},tt=async(t,e,n=!1,a)=>{const r=n?await Lt(t,a):await(await fetch(t)).arrayBuffer(),o=new Blob([r],{type:e});return URL.createObjectURL(o)},it=document.getElementById("transcodeStatus"),X=document.getElementById("transcodeText"),ct=document.getElementById("transcodeBar"),d={NONE:"none",TRANSCODING:"doing",DONE:"done",ERROR:"error",SKIPPED:"skipped"},O={NONE:"none",UPLOADING:"uploading",DONE:"done",ERROR:"error"},S={IDLE:"idle",TRANSCODING:"transcoding",RUNNING:"running",ERROR:"error"};console.log("[DEBUG]",{crossOriginIsolated:window.crossOriginIsolated,sab:typeof SharedArrayBuffer,location:location.href});const K=document.getElementById("autoUploadAfterTranscode");function At(){return K==null?void 0:K.checked}let F=null,L=null,B=!1,$=S.IDLE;Object.defineProperty(window,"currentStreamStatus",{get(){return $},set(t){if($===t)return;const e=$;$=t,console.log("[StreamStatus]",e,"â†’",t),dt()}});function Tt(){if(L&&L.readyState===WebSocket.OPEN)return;const e=`${location.protocol==="https:"?"wss":"ws"}://${location.host}/ws/stream`;L=new WebSocket(e);let n=null;L.onopen=()=>{n=setInterval(()=>{L.readyState===WebSocket.OPEN&&L.send(JSON.stringify({type:"keepalive"}))},25e3),console.log("[WS] stream connected")},L.onclose=()=>{clearInterval(n),console.warn("[WS] stream disconnected")},L.onerror=a=>{clearInterval(n),console.warn("[WS] stream error",a)},L.onmessage=a=>{let r;try{r=JSON.parse(a.data)}catch{console.warn("[WARN] failed to parse websocket message");return}console.log("receive websocket message"),r.type==="stream-status"&&(r.status==="error"&&(q(),currentStreamStatus=S.ERROR,f("âŒ æ¨æµå‡ºé”™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜","error")),r.status==="stopped"&&(q(),currentStreamStatus=S.IDLE,f("â¹ æ¨æµå·²ç»“æŸ","info")),r.status==="running"&&f("âœ… æ¨æµä¸­","ok"),r.status==="info"&&f(`${r.message}`,"info"))}}async function G(){if(F)return F;const t=await fetch("/api/internal/admin-token");if(!t.ok)throw new Error("æ— æ³•è·å– admin token");return F=(await t.json()).token,F}const p=[],Y=new Set,et=document.getElementById("playlist"),nt=document.getElementById("emptyTip"),at=document.getElementById("status"),x=document.getElementById("mode"),W=document.getElementById("loopSelector"),J=document.getElementById("loopTarget"),bt=document.getElementById("fileInput"),j=document.getElementById("startBtn");function lt(t){return`${t.name}|${t.size}|${t.lastModified}`}function Pt(t){return(t/1024/1024).toFixed(1)+" MB"}function f(t,e=""){at.textContent=t,at.className="status "+e}function g(){if(et.innerHTML="",J.innerHTML="",p.length===0){nt.style.display="block",W.classList.add("hidden");return}nt.style.display="none",p.forEach((t,e)=>{const n=t.originalFile;let a="",r="";t.transcodeStatus===d.DONE||t.transcodeStatus===d.SKIPPED?(a="âœ… å·²è½¬ç ",r="ok"):t.transcodeStatus===d.TRANSCODING?(a="â³ æ­£åœ¨è½¬ç ",r="info"):t.transcodeStatus===d.ERROR&&(a="âŒ è½¬ç å¤±è´¥",r="error");let o="",i="";t.cacheStatus===O.DONE?(o="ğŸ“¦ å·²ç¼“å­˜",i="ok"):t.cacheStatus===O.UPLOADING?(o="ğŸ“¦ ä¸Šä¼ ä¸­",i="info"):t.cacheStatus===O.ERROR&&(o="ğŸ“¦ ä¸Šä¼ å¤±è´¥",i="error");let E=`
            <div class="actions">
                <button onclick="removeItem(${e})">ç§»é™¤</button>
            </div>
        `;t.transcodeStatus===d.ERROR&&(E=`
                <div class="actions">
                <button onclick="retryTranscode(${e})">ğŸ” é‡è¯•</button>
                <button onclick="removeItem(${e})">ç§»é™¤</button>
                </div>
            `),t.cacheStatus===O.ERROR&&(E=`
                <div class="actions">
                <button onclick="retryCacheUpload(${e})">ğŸ“¦ é‡è¯•ä¸Šä¼ </button>
                <button onclick="removeItem(${e})">ç§»é™¤</button>
                </div>
            `);const D=document.createElement("li");D.innerHTML=`
            <span>
                ${e+1}. ${n.name}
                <span class="small">(${Pt(n.size)})</span>
                ${a?`<span class="small ${r}" style="margin-left:8px;">${a}</span>`:""}
                ${o?`<span class="small ${i}" style="margin-left:6px;">${o}</span>`:""}
            </span>
            ${E}
            `,et.appendChild(D);const l=document.createElement("option");l.value=e,l.textContent=n.name,J.appendChild(l)}),x.value==="loop"&&W.classList.remove("hidden")}function dt(){const t=currentStreamStatus===S.TRANSCODING||currentStreamStatus===S.RUNNING;j.disabled=t,j.classList.toggle("opacity-50",t),j.classList.toggle("cursor-not-allowed",t)}async function kt(t){const e=p[t];e&&(e.transcodeStatus=d.NONE,g(),f(`è¯·ç‚¹å‡»å¼€å§‹æ¨æµæ¥é‡æ–°è½¬ç ï¼š${e.originalFile.name}`))}async function Ut(t){const e=p[t];if(!(!e||e.transcodeStatus!==d.DONE))try{e.cacheStatus=O.UPLOADING,g(),await ft(e,e.transcodedFile,e.fingerprint),e.cacheStatus=O.DONE}catch{console.warn(`[WARN] failed to upload transcoded video: ${e.originalFile.name}`),e.cacheStatus=O.ERROR}finally{g()}}function _t(){return p.some(t=>t.transcodeStatus===d.ERROR)}function vt(){return p.some(t=>t.transcodeStatus===d.DONE||t.transcodeStatus===d.SKIPPED)}function Bt(t){const n=p[t].originalFile;Y.delete(lt(n)),p.splice(t,1),g()}async function Ct(t){const e=await t.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",e);return[...new Uint8Array(n)].map(a=>a.toString(16).padStart(2,"0")).join("")}async function rt(t){const e=await G(),n=await fetch("/api/stream/check",{method:"POST",headers:{"Content-Type":"application/json","x-admin-token":e},body:JSON.stringify({fingerprint:t})});return n.ok?await n.json():null}function H(){it.style.display="none"}function ut(){const t=navigator.userAgent;if(/^((?!chrome|android).)*safari/i.test(t))return!1;let n=!1;try{n=typeof SharedArrayBuffer<"u"}catch{n=!1}return!Ft()&&n&&"Worker"in window}function Ft(){return/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)}function $t(t){if(p.length===1)return!1;const e=p.some(n=>n.transcodeStatus===d.ERROR);return!(t===p.length-1&&!e)}function q(){for(const t of p)(t.transcodeStatus===d.SKIPPED||t.transcodeStatus===d.DONE)&&(t.transcodeStatus=d.NONE)}async function xt(){if(console.log(`Stream status: ${currentStreamStatus}`),currentStreamStatus!==S.IDLE&&currentStreamStatus!==S.ERROR)return;if(p.length===0){f("âŒ æ’­æ”¾åˆ—è¡¨ä¸ºç©º","error");return}q(),currentStreamStatus=S.TRANSCODING;const t=x.value,e=new FormData,n=await G(),a=ut();f(a?"ğŸ–¥ï¸ æ¡Œé¢ç¯å¢ƒï¼Œä½¿ç”¨å®¢æˆ·ç«¯è½¬ç â€¦":"ğŸ“± ç§»åŠ¨ç«¯æˆ–ä¸æ”¯æŒè½¬ç ï¼Œä½¿ç”¨æœåŠ¡å™¨è½¬ç â€¦");const r=[],o=[];if(t==="loop"){const l=Number(J.value),m=p[l],u=m.originalFile,I=m.fingerprint,y=await rt(I);if(y!=null&&y.exists)o.push({filePath:y.path,index:l}),m.transcodeStatus=d.DONE,g();else{if(!a){f("âŒ å½“å‰ç¯å¢ƒä¸æ”¯æŒå®¢æˆ·ç«¯è½¬ç ","error"),currentStreamStatus=S.ERROR;return}console.log("[INFO] å¼€å§‹è½¬ç ..."),C(0,"å‡†å¤‡è½¬ç ç¬¬ 1 / 1 ä¸ªè§†é¢‘"),m.transcodeStatus=d.TRANSCODING,g();const _=await st(u,0,1);r.push({file:_,fingerprint:I,index:l}),m.transcodeStatus=d.DONE,g()}e.append("loopIndex",l)}else{const l=p.length;for(let m=0;m<p.length;m++){const u=p[m];if(u.transcodeStatus===d.DONE||u.transcodeStatus===d.SKIPPED){u.transcodeStatus=d.SKIPPED;continue}if(u.transcodeStatus===d.ERROR)continue;const I=u.originalFile,y=u.fingerprint,_=await rt(y);if(_!=null&&_.exists){o.push({filePath:_.path,index:m}),u.transcodeStatus=d.NONE,u.cacheStatus=O.DONE,g();continue}if(!a){f("âŒ å½“å‰ç¯å¢ƒä¸æ”¯æŒå®¢æˆ·ç«¯è½¬ç ","error"),currentStreamStatus=S.ERROR;return}C(0,`å‡†å¤‡è½¬ç ç¬¬ ${m+1} / ${l} ä¸ªè§†é¢‘ï¼š${I.name}`),u.transcodeStatus=d.TRANSCODING,g(),console.log("[INFO] å¼€å§‹è½¬ç ...");try{const P=await st(I,m,l);if(r.push({file:P,fingerprint:y,index:m}),u.transcodedFile=P,u.transcodeStatus=d.DONE,g(),At()&&$t(m))try{u.cacheStatus=O.UPLOADING,g(),await ft(u,P,y)}catch(pt){console.warn("[cache] upload failed",pt)}finally{g()}}catch(P){if(String(P==null?void 0:P.message).includes("called FFmpeg.terminate()")){u.transcodeStatus=d.NONE,f("è½¬ç å–æ¶ˆ"),g(),H(),currentStreamStatus=S.IDLE;return}else u.transcodeStatus=d.ERROR;m==l-1&&H(),g();continue}}}if(o.length==0&&r.length==0){f("æ–‡ä»¶è½¬ç å¤±è´¥","error"),currentStreamStatus=S.ERROR;return}for(const l of r)l.cacheStatus==O.DONE&&l.cachedPath.length>0?o.push({filePath:l.cachedPath,index:l.index}):(e.append("files",l.file,l.file.name),e.append("fingerprints",l.fingerprint),e.append("indexs",l.index));r.length>0&&e.append("clientTranscoded","1");for(const l of o)e.append("existing",JSON.stringify(l));if(e.append("mode",t),H(),_t()){if(!vt()){alert("âŒ æ‰€æœ‰è§†é¢‘å‡è½¬ç å¤±è´¥ï¼Œæ— æ³•å¼€å§‹æ¨æµ"),f("âŒ è½¬ç å¤±è´¥ï¼Œè¯·å¤„ç†åé‡è¯•","error"),currentStreamStatus=S.ERROR;return}if(f("âš ï¸ è½¬ç å®Œæˆï¼Œå­˜åœ¨å¤±è´¥è§†é¢‘ï¼Œç­‰å¾…ç¡®è®¤â€¦"),!window.confirm(`âš ï¸ æœ‰è§†é¢‘è½¬ç å¤±è´¥ã€‚

ç‚¹å‡»ã€Œç¡®å®šã€å°†å¿½ç•¥å¤±è´¥çš„è§†é¢‘ï¼Œä»…æ¨æµå·²è½¬ç æˆåŠŸçš„å†…å®¹ã€‚
ç‚¹å‡»ã€Œå–æ¶ˆã€è¿”å›å¤„ç†å¤±è´¥è§†é¢‘ï¼ˆé‡è¯•æˆ–ç§»é™¤ï¼‰ã€‚`)){f("â¸ å·²å–æ¶ˆæ¨æµï¼Œè¯·å¤„ç†å¤±è´¥çš„è§†é¢‘"),currentStreamStatus=S.IDLE;return}}f("ğŸ“¡ æ­£åœ¨å¯åŠ¨æ¨æµâ€¦"),currentStreamStatus=S.RUNNING;const i=location.hostname.endsWith("ledbygrace.live")?"https://upload.ledbygrace.live":"",E=await fetch(`${i}/api/stream/start`,{method:"POST",headers:{"x-admin-token":n},body:e}),D=await E.text();E.ok?f("âœ… æ¨æµä¸­","ok"):f("âŒ "+D,"error")}async function Wt(){const t=await G();(await fetch("/api/stream/stop",{method:"POST",headers:{"x-admin-token":t}})).ok||f("è¯·æ±‚åœæ­¢æ¨æµå¤±è´¥")}async function ft(t,e,n){if(t.cacheStatus===O.DONE)return;const a=await G(),r=new FormData;r.append("file",e,e.name),r.append("fingerprint",n);const o=location.hostname.endsWith("ledbygrace.live")?"https://upload.ledbygrace.live":"",i=await fetch(`${o}/api/stream/cache`,{method:"PUT",headers:{"x-admin-token":a},body:r});if(!i.ok)throw t.cacheStatus=O.ERROR,new Error("UPLOAD_CACHE_FAILED");t.cacheStatus=O.DONE,t.cachedPath=i.path}const Mt=2*60*60,Gt="/stream/ffmpeg";function Kt(){return Gt}let N,ot=!1;async function jt(){if(!(N||ot)){if(!ut()){console.log("[ffmpeg] client transcode not supported, skip preload");return}ot=!0,f("â³ åˆå§‹åŒ–è½¬ç å¼•æ“â€¦");try{await Et(),f("âœ… è½¬ç å¼•æ“å°±ç»ª")}catch(t){console.warn("[ffmpeg] preload failed",t),f("âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå®¢æˆ·ç«¯è½¬ç ")}}}async function Et(){if(N)return N;N=new Ot;const t=Kt();return await N.load({coreURL:await tt(`${t}/ffmpeg-core.js`,"text/javascript"),wasmURL:await tt(`${t}/ffmpeg-core.wasm`,"application/wasm")}),N.on("progress",({progress:e,time:n})=>{if(!B)return;const a=Math.min(99,Math.round(e*100));C(a)}),N.on("error",e=>console.error("[ERROR]",e.message)),N}const z=24;async function st(t,e,n){if(t.duration&&t.duration>Mt)throw new Error("è§†é¢‘æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é‡æ–°ä¸Šä¼ ä¸è¶…è¿‡2Gçš„æ–‡ä»¶ã€‚");B=!0,console.log("[INFO] loading ffmpeg");const a=await Et();console.log("[INFO] load ffmpeg success");const r=`input-${Date.now()}.mp4`,o=`output-${Date.now()}.mp4`;C(0,`å‡†å¤‡è½¬ç ç¬¬ ${e+1}/${n} ä¸ªè§†é¢‘`),await a.writeFile(r,await It(t));try{console.log("[INFO] start transcoding..."),await a.exec(["-i",r,"-vf",`format=yuv420p,fps=${z}`,"-c:v","libx264","-pix_fmt","yuv420p","-preset","veryfast","-crf","24","-g",String(z*2),"-keyint_min",String(z),"-sc_threshold","0","-c:a","aac","-strict","experimental","-ar","44100","-ac","2","-b:a","128k","-movflags","+faststart",o])}catch(E){throw console.error("[transcode] ffmpeg failed",E),E}finally{B=!1}let i;try{i=await a.readFile(o)}catch(E){throw console.log(`[ERROR] failed to read transcoded data, error:${E}`),E}if(!i||i.length===0)throw console.error("[transcode] empty output file",{file:t.name,size:t.size}),new Error("CLIENT_TRANSCODE_EMPTY_OUTPUT");try{await a.deleteFile(r),await a.deleteFile(o)}catch(E){console.warn(`[WARN] unlink file failed, error: ${E}`)}return console.log("[INFO] finish transcode"),C(100,"âœ… è½¬ç å®Œæˆ"),new File([i.buffer],t.name.replace(/\.\w+$/,".mp4"),{type:"video/mp4"})}async function Ht(){!N||!B||(console.warn("[ffmpeg] terminate worker"),await N.terminate(),N=null,B=!1,X.textContent="è½¬ç å·²å–æ¶ˆ",ct.style.width="0%",f("â›” å·²å–æ¶ˆè½¬ç ","info"))}function C(t,e){it.style.display="block",ct.style.width=`${t}%`,e?X.textContent=e:X.textContent=`è½¬ç ä¸­â€¦ ${t}%`}function zt(){bt.addEventListener("change",async t=>{jt();const e=Array.from(t.target.files);if(!e.length)return;let n=!1;for(let a=0;a<e.length;a++){const r=e[a],o=lt(r);if(Y.has(o))continue;const i=await Ct(r);p.push({index:a,originalFile:r,fingerprint:i,transcodeStatus:d.NONE,cacheStatus:O.NONE,cachedPath:""}),Y.add(o),n=!0}t.target.value="",n&&g()}),x.addEventListener("change",()=>{x.value==="loop"&&p.length>0?W.classList.remove("hidden"):W.classList.add("hidden")})}document.addEventListener("DOMContentLoaded",()=>{Tt(),zt(),dt()});window.start=xt;window.stop=Wt;window.cancelTranscode=Ht;window.removeItem=Bt;window.retryTranscode=kt;window.retryCacheUpload=Ut;
